/* syngen v2.0.0-beta.2 */
(()=>{"use strict";const t=(()=>{const t=new AudioContext,e=new Promise(t=>{document.addEventListener("DOMContentLoaded",t)});return{buffer:{},circuit:{},context:()=>t,ear:{filterModel:{},gainModel:{}},effect:{},input:{},ready:t=>"function"==typeof t?e.then(t):e,time:(e=0)=>t.currentTime+e,tool:{}}})();t.const={},t.const.eulerToQuaternion="ZYX",t.const.gravity=66743e-15,t.const.maxFrequency=2e4,t.const.maxSafeFloat=2**43-1,t.const.midiReferenceFrequency=440,t.const.midiReferenceNote=69,t.const.minFrequency=20,t.const.speedOfSound=343,t.const.tau=2*Math.PI,t.const.unit2=Math.sqrt(2)/2,t.const.unit3=Math.sqrt(3)/3,t.const.unit4=Math.sqrt(4)/4,t.const.zero=10**-32,t.const.zeroDb=-96,t.const.zeroGain=10**-9.6,t.const.zeroTime=.005,t.fn={},t.fn.accelerateValue=(e,n,i,r=void 0)=>{if(void 0===r&&(r=i),e==n)return n;const o=t.loop.delta()*(Math.abs(n)>=Math.abs(e)&&Math.sign(e)==Math.sign(n)?i:r);return t.fn.between(n,e-o,e+o)?n:e>n?e-o:e+o},t.fn.accelerateVector=(e,n,i,r=void 0)=>{void 0===r&&(r=i),t.tool.vector3d.prototype.isPrototypeOf(e)||(e=t.tool.vector3d.create(e)),t.tool.vector3d.prototype.isPrototypeOf(n)||(n=t.tool.vector3d.create(n));const o=e.clone();if(e.equals(n))return o;const s=n.subtract(e).normalize();for(const a of["x","y","z"])o[a]=t.fn.accelerateValue(e[a],n[a],i*Math.abs(s[a]),r*Math.abs(s[a]));return o},t.fn.addInterval=(t,e)=>t*2**e,t.fn.between=(t,e,n)=>t>=Math.min(e,n)&&t<=Math.max(e,n),t.fn.centroid=(...e)=>{if(!e.length)return t.tool.vector3d.create();let n=0,i=0,r=0;for(const t of e)n+=t.x||0,i+=t.y||0,r+=t.z||0;return t.tool.vector3d.create({x:n/e.length,y:i/e.length,z:r/e.length})},t.fn.choose=(e=[],n=0)=>{n=t.fn.clamp(n,0,1);return e[Math.round(n*(e.length-1))]},t.fn.chooseSplice=(e=[],n=0)=>{n=t.fn.clamp(n,0,1);const i=Math.round(n*(e.length-1));return e.splice(i,1)[0]},t.fn.chooseWeighted=(e=[],n=0)=>{let i=(n=t.fn.clamp(n,0,1))*e.reduce((t,e)=>t+(e.weight||0),0);for(const t of e)if(i-=t.weight||0,i<=0)return t},t.fn.clamp=(t,e=0,n=1)=>t>n?n:t<e?e:t,t.fn.closer=(t,e,n)=>Math.abs(t-e)<=Math.abs(t-n)?e:n,t.fn.closest=function(e,n=[]){return n.reduce((n,i)=>t.fn.closer(e,n,i),n[0])},t.fn.createNoise=({noScale:e=[],seed:n,octaves:i=1,type:r}={})=>{if(!(r={"1d":t.tool.noise,perlin2d:t.tool.perlin2d,perlin3d:t.tool.perlin3d,perlin4d:t.tool.perlin4d,simplex2d:t.tool.simplex2d,simplex3d:t.tool.simplex3d,simplex4d:t.tool.simplex4d}[r]))throw new Error("Incorrect type.");if(1==(i=Math.max(1,Math.round(i))))return r.create(n);const o=1/(1-2**-i),s=[];Array.isArray(n)||(n=[n]);for(let t=0;t<i;t+=1)s.push(r.create(...n,"octave",t));const a=e.includes(0),c=e.includes(1),u=e.includes(2),h=e.includes(3);return{layer:s,reset:function(){for(let t of this.layer)t.reset();return this},value:function(...t){let e=.5,n=1,i=0;for(let r in this.layer){i+=this.layer[r].value(a?t[0]:t[0]*n,c?t[1]:t[1]*n,u?t[2]:t[2]*n,h?t[3]:t[3]*n)*e,e/=2,n*=2}return i*=o,i}}},t.fn.deg2rad=t=>t*Math.PI/180,t.fn.debounced=function(t,e=0){let n;return(...i)=>{clearTimeout(n),n=setTimeout(()=>t(...i),e)}},t.fn.detune=(t,e=0)=>t*2**(e/1200),t.fn.distance=(e,n)=>Math.sqrt(t.fn.distance2(e,n)),t.fn.distance2=({x:t=0,y:e=0,z:n=0}={},{x:i=0,y:r=0,z:o=0}={})=>(i-t)*(i-t)+(r-e)*(r-e)+(o-n)*(o-n),t.fn.extend=function(t={},e={}){return"function"==typeof e&&(e=e(t)),Object.setPrototypeOf({...e},t)},t.fn.fromDb=t=>10**(t/10),t.fn.fromMidi=e=>t.const.midiReferenceFrequency*Math.pow(2,(e-t.const.midiReferenceNote)/12),t.fn.hash=t=>{let e=0,n=(t=String(t)).length;for(;n--;)e+=t.charCodeAt(n),e+=e<<10,e^=e>>6;return e+=e<<3,e^=e>>11,e+=e<<15,Math.abs(e)},t.fn.holdParam=function(e){return e.cancelScheduledValues(0),e.setValueAtTime(e.value,t.time()),this},t.fn.humanize=(e=1,n=0)=>e+t.fn.randomFloat(-n,n),t.fn.humanizeDb=(e=1,n=0)=>{const i=t.fn.fromDb(n);return e*t.fn.randomFloat(1-i,1+i)},t.fn.intersects=({depth:e=0,height:n=0,width:i=0,x:r=0,y:o=0,z:s=0}={},{depth:a=0,height:c=0,width:u=0,x:h=0,y:l=0,z:f=0}={})=>{const d=t.fn.between,p=d(r,h,h+u)||d(h,r,r+i),m=d(o,l,l+c)||d(l,o,o+n),y=d(s,f,f+a)||d(f,s,s+e);return p&&m&&y},t.fn.lerp=(t,e,n=0)=>t*(1-n)+e*n,t.fn.lerpExp=(e,n,i=0,r=2)=>t.fn.lerp(e,n,i**r),t.fn.lerpExpRandom=([e,n],[i,r],o,s)=>t.fn.randomFloat(t.fn.lerpExp(e,i,o,s),t.fn.lerpExp(n,r,o,s)),t.fn.lerpLog=(e,n,i=0,r=2)=>(i*=r-1,t.fn.lerp(e,n,Math.log(1+i)/Math.log(r))),t.fn.lerpLogi=(e,n,i,r)=>t.fn.lerpLog(n,e,1-i,r),t.fn.lerpLogiRandom=([e,n],[i,r],o)=>t.fn.randomFloat(t.fn.lerpLogi(e,i,o),t.fn.lerpLogi(n,r,o)),t.fn.lerpLogRandom=([e,n],[i,r],o,s)=>t.fn.randomFloat(t.fn.lerpLog(e,i,o,s),t.fn.lerpLog(n,r,o,s)),t.fn.lerpRandom=([e,n],[i,r],o)=>t.fn.randomFloat(t.fn.lerp(e,i,o),t.fn.lerp(n,r,o)),t.fn.normalizeAngle=(t=0)=>{const e=2*Math.PI;return t>e?t%=e:t<0&&(t%=e,t+=e),t},t.fn.normalizeAngleSigned=e=>t.fn.normalizeAngle(e)-Math.PI,t.fn.promise=(t=0)=>{const e={},n=new Promise((t,n)=>{e.reject=n,e.resolve=t}),i=setTimeout(e.resolve,t);return n.reject=function(...t){return e.reject(...t),clearTimeout(i),this},n.resolve=function(...t){return e.resolve(...t),clearTimeout(i),this},n.catch(()=>{}),n},t.fn.quadratic=(t,e,n)=>[(-1*e+Math.sqrt(Math.pow(e,2)-4*t*n))/(2*t),(-1*e-Math.sqrt(Math.pow(e,2)-4*t*n))/(2*t)].filter(isFinite),t.fn.rad2deg=t=>180*t/Math.PI,t.fn.rampCurve=function(e,n,i=t.const.zeroTime){return e.cancelScheduledValues(0),e.setValueCurveAtTime(n,t.time(),t.time(i)),this},t.fn.rampExp=function(e,n,i=t.const.zeroTime){return t.fn.holdParam(e),e.exponentialRampToValueAtTime(n,t.time(i)),this},t.fn.rampLinear=function(e,n,i=t.const.zeroTime){return t.fn.holdParam(e),e.linearRampToValueAtTime(n,t.time(i)),this},t.fn.randomFloat=(t=0,e=1)=>t+Math.random()*(e-t),t.fn.randomInt=function(t=0,e=1){return Math.round(this.randomFloat(t,e))},t.fn.randomSign=()=>Math.random()<.5?1:-1,t.fn.randomKey=function(t){const e=t instanceof Map?[...t.keys()]:Object.keys(t);return e[this.randomInt(0,e.length-1)]},t.fn.randomValue=function(t){t instanceof Set&&(t=[...t.values()]);const e=this.randomKey(t);return t instanceof Map?t.get(e):t[e]},t.fn.regularPolygonInteriorAngle=t=>(t-2)*Math.PI/t,t.fn.round=(t,e=0)=>(e=10**e,Math.round(t*e)/e),t.fn.scale=(t,e,n,i,r)=>(r-i)*(t-e)/(n-e)+i,t.fn.setParam=function(e,n){return t.fn.rampLinear(e,n,t.performance.delta()),this},t.fn.shuffle=(t,e=Math.random)=>{for(let n=(t=[].slice.call(t)).length-1;n>0;n--){const i=Math.floor(e()*(n+1));[t[n],t[i]]=[t[i],t[n]]}return t},t.fn.smooth=(t,e=10)=>1/(1+Math.E**(-e*(t-.5))),t.fn.srand=(...e)=>{const n=34359738337,i=t=>(185852*t+1)%n;let r=t.fn.hash(t.seed.concat(...e));r=i(r);return(t=0,e=1)=>(r=i(r),t+r/n*(e-t))},t.fn.toCents=(t,e)=>(e-t)/t*1200,t.fn.toDb=t=>10*Math.log10(t),t.fn.toMidi=e=>12*Math.log2(e/t.const.midiReferenceFrequency)+t.const.midiReferenceNote,t.fn.transpose=(e,n=t.const.minFrequency,i=t.const.maxFrequency)=>{for(;e>i;)e/=2;for(;e<n;)e*=2;return e},t.fn.uuid=()=>([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,t=>(t^crypto.getRandomValues(new Uint8Array(1))[0]&15>>t/4).toString(16)),t.fn.wrap=(t,e=0,n=1)=>{const i=n-e;return t>=n?e+(t-e)%i:t<e?e+(t+n)%i:t},t.fn.wrapAlternate=(t,e=0,n=1)=>{const i=n-e,r=2*i;return t>n?(t-=e)%r<i?e+t%i:n-t%i:t<e?Math.abs(t%r)<i?n-i+Math.abs(t%i):e+i-Math.abs(t%i):t},t.tool.bitree={},t.tool.bitree.create=function(t={}){return Object.create(this.prototype).construct(t)},t.tool.bitree.from=function(t=[],e={}){const n=this.create(e);for(const e of t)n.insert(e);return n},t.tool.bitree.prototype={clear:function(){return this.items.length=0,this.nodes.length=0,this},construct:function({dimension:e="value",maxItems:n=12,minValue:i=-t.const.maxSafeFloat,range:r=2*t.const.maxSafeFloat}={}){return this.dimension=e,this.items=[],this.maxItems=n,this.minValue=i,this.nodes=[],this.range=r,this},destroy:function(){return this.clear()},find:function(t,e=1/0){if(!(this.dimension in t))return;if(isFinite(e)&&!this.intersects(t[this.dimension]-e,2*e))return;const n=e=>Math.abs(e[this.dimension]-t[this.dimension]),i=this.getIndex(t);if(-1==i){let i,r=e;for(const e of this.items){if(e===t)continue;const o=n(e);o<r&&(r=o,i=e)}return i}let r=this.nodes[i].find(t,e),o=r?n(r):1/0;for(const e of this.nodes){if(e===this.nodes[i])continue;const s=e.find(t,o);if(!s)continue;const a=n(s);a<o&&(o=a,r=s)}return r},getIndex:function(t){if(!this.nodes.length)return-1;const e=this.minValue+this.range/2;return t[this.dimension]<=e?0:1},insert:function(t={}){if(!(this.dimension in t))return this;const e=this.getIndex(t);return-1!=e?(this.nodes[e].insert(t),this):(this.items.push(t),this.items.length>this.maxItems&&this.split(),this)},intersects:function(e,n){return t.fn.between(this.minValue,e,e+n)||t.fn.between(e,this.minValue,this.minValue+this.range)},remove:function(t){if(this.nodes.length){const e=this.getIndex(t);return this.nodes[e].remove(t),this}const e=this.items.indexOf(t);return-1!=e&&this.items.splice(e,1),this},retrieve:function(t,e){const n=[];if(!this.intersects(t,e))return n;for(const i of this.items)i[this.dimension]>=t&&i[this.dimension]<=t+e&&n.push(i);for(const i of this.nodes)n.push(...i.retrieve(t,e));return n},split:function(){if(this.nodes.length)return this;const e=this.range/2;this.nodes[0]=t.tool.bitree.create({dimension:this.dimension,maxItems:this.maxItems,minValue:this.minValue,range:e}),this.nodes[1]=t.tool.bitree.create({dimension:this.dimension,maxItems:this.maxItems,minValue:this.minValue+e,range:e});for(const t of this.items){const e=this.getIndex(t);this.nodes[e].insert(t)}return this.items.length=0,this}},t.tool.cache2d={},t.tool.cache2d.create=function(...t){return Object.create(this.prototype).construct(...t)},t.tool.cache2d.prototype={construct:function(){return this.map=new Map,this},destroy:function(){return this.map.clear(),this},has:function(t,e){return Boolean(this.map.get(t)?.has(e))},get:function(t,e){return this.map.get(t)?.get(e)},reset:function(){return this.map.clear(),this},set:function(t,e,n){let i=this.map.get(t);return i||(i=new Map,this.map.set(t,i)),i.set(e,n),this}},t.tool.cache3d={},t.tool.cache3d.create=function(...t){return Object.create(this.prototype).construct(...t)},t.tool.cache3d.prototype={construct:function(){return this.map=new Map,this},destroy:function(){return this.map.clear(),this},has:function(t,e,n){return Boolean(this.map.get(t)?.get(e)?.has(n))},get:function(t,e,n){return this.map.get(t)?.get(e)?.get(n)},reset:function(){return this.map.clear(),this},set:function(t,e,n){let i=this.map.get(t);i||(i=new Map,this.map.set(t,i));let r=i.get(e);return r||(r=new Map,i.set(e,r)),r.set(z,n),this}},t.tool.cone={},t.tool.cone.create=function(...t){return Object.create(this.prototype).construct(...t)},t.tool.cone.prototype={construct:function({height:e=0,normal:n,radius:i=0,vertex:r}={}){return this.height=e,this.normal=t.tool.vector3d.create(n),this.radius=i,this.vertex=t.tool.vector3d.create(r),this},containsPoint:function(e){const n=(e=t.tool.vector3d.create(e)).subtract(this.vertex).dotProduct(this.normal);if(!t.fn.between(n,0,this.height))return!1;const i=n/this.height*this.radius,r=this.vertex.add(this.normal.scale(n));return e.distance(r)<=i},containsSphere:function(e,n){const i=(e=t.tool.vector3d.create(e)).subtract(this.vertex).dotProduct(this.normal);if(!t.fn.between(i,-n,this.height+n))return!1;const r=i/this.height*this.radius,o=this.vertex.add(this.normal.scale(i));return e.distance(o)<=r+n}},t.tool.euler={},t.tool.euler.create=function(t={}){return Object.create(this.prototype).construct(t)},t.tool.euler.fromQuaternion=function({w:e=0,x:n=0,y:i=0,z:r=0}={},o=t.const.eulerToQuaternion){const s=e**2,a=e*n,c=e*i,u=e*r,h=n**2,l=n*i,f=n*r,d=i**2,p=i*r,m=r**2;switch(o){case"XYZ":return this.create({pitch:Math.asin(2*(f+c)),roll:Math.atan2(-2*(p-a),s-h-d+m),yaw:Math.atan2(-2*(l-u),s+h-d-m)});case"XZY":return this.create({pitch:Math.atan2(2*(f+c),s+h-d-m),roll:Math.atan2(2*(p+a),s-h+d-m),yaw:Math.asin(-2*(l-u))});case"YXZ":return this.create({pitch:Math.atan2(2*(f+c),s-h-d+m),roll:Math.asin(-2*(p-a)),yaw:Math.atan2(2*(l+u),s-h+d-m)});case"YZX":return this.create({pitch:Math.atan2(-2*(f-c),s+h-d-m),roll:Math.atan2(-2*(p-a),s-h+d-m),yaw:Math.asin(2*(l+u))});case"ZXY":return this.create({pitch:Math.atan2(-2*(f-c),s-h-d+m),roll:Math.asin(2*(p+a)),yaw:Math.atan2(-2*(l-u),s-h+d-m)});case"ZYX":return this.create({pitch:Math.asin(-2*(f-c)),roll:Math.atan2(2*(p+a),s-h-d+m),yaw:Math.atan2(2*(l+u),s+h-d-m)})}},t.tool.euler.prototype={clone:function(){return t.tool.euler.create(this)},construct:function({pitch:t=0,roll:e=0,yaw:n=0}={}){return this.pitch=t,this.roll=e,this.yaw=n,this},equals:function({pitch:t=0,roll:e=0,yaw:n=0}={}){return this.pitch==t&&this.roll==e&&this.yaw==n},forward:function(){return t.tool.vector3d.unitX().rotateEuler(this)},isZero:function(){return!this.pitch&&!this.roll&&!this.yaw},pitch:0,right:function(){return t.tool.vector3d.unitY().rotateEuler(this)},roll:0,scale:function(e=0){return t.tool.euler.create({pitch:this.pitch*e,roll:this.roll*e,yaw:this.yaw*e})},set:function({pitch:t=0,roll:e=0,yaw:n=0}={}){return this.pitch=t,this.roll=e,this.yaw=n,this},up:function(){return t.tool.vector3d.unitZ().rotateEuler(this)},yaw:0},t.tool.fsm={},t.tool.fsm.create=function(t={}){return Object.create(this.prototype).construct(t)},t.tool.fsm.prototype={change:function(t,e={}){if(!(t in this.transition)||this.is(t))return this;const n={currentState:this.state,event:this._lastEvent,nextState:t,...e};this.pubsub.emit("exit",n),this.pubsub.emit(`exit-${this.state}`,n);const i={currentState:t,event:this._lastEvent,previousState:this.state,...e};return this.setState(t),this.pubsub.emit("enter",i),this.pubsub.emit(`enter-${this.state}`,i),this},construct:function({state:e="none",transition:n={}}={}){return this.transition={...n},this.setState(e),t.tool.pubsub.decorate(this),this},destroy:function(){return this.pubsub.destroy(),this},dispatch:function(t,e={}){const n=this.transition[this.state];if(!n)return this;const i=n[t];if(i){const n=this.state,r={event:t,state:n,...e};this.pubsub.emit("before",r),this.pubsub.emit(`before-${t}`,r),this.pubsub.emit(`before-${n}-${t}`,r),this._lastEvent=t,i.call(this,e),delete this._lastEvent;const o={currentState:this.state,event:t,previousState:n,...e};this.pubsub.emit("after",o),this.pubsub.emit(`after-${t}`,o),this.pubsub.emit(`after-${n}-${t}`,o)}return this},getState:function(){return this.state},is:function(t){return this.state==t},setState:function(t){return t in this.transition&&(this.state=t),this},state:void 0},t.tool.generator2d={},t.tool.generator2d.create=function(...t){return Object.create(this.prototype).construct(...t)},t.tool.generator2d.prototype={construct:function({generator:e=()=>{},radius:n=1,scale:i=1}={}){return this.cache=t.tool.cache2d.create(),this.generate=e.bind(this),this.loaded=[],this.radius=n,this.scale=i,t.tool.pubsub.decorate(this),this},reset:function(){for(const t of this.loaded)this.emit("unload",t);return this.cache.reset(),delete this.current,this.loaded=[],this},update:function(){const e=t.position.getVector(),n=Math.round(e.x/this.scale),i=Math.round(e.y/this.scale);if(this.current&&this.current.x==n&&this.current.y==i)return this;const r=this.radius,o=[],s=new Set,a=new Set(this.loaded);for(let t=n-r;t<=n+r;t+=1)for(let e=i-r;e<=i+r;e+=1){let n=this.cache.get(t,e);n?a.delete(n):(n={x:t,y:e,...this.generate(t,e)||{}},this.cache.set(t,e,n),s.add(n)),o.push(n)}for(const t of s)this.pubsub.emit("load",t);for(const t of a)this.pubsub.emit("unload",t);return this.loaded=o,this.current=this.cache.get(n,i),this}},t.tool.generator3d={},t.tool.generator3d.create=function(...t){return Object.create(this.prototype).construct(...t)},t.tool.generator3d.prototype={construct:function({generator:e=()=>{},radius:n=1,scale:i=1}={}){return this.cache=t.tool.cache3d.create(),this.generate=e.bind(this),this.loaded=[],this.radius=n,this.scale=i,t.tool.pubsub.decorate(this),this},reset:function(){for(const t of this.loaded)this.emit("unload",t);return this.cache.reset(),delete this.current,this.loaded=[],this},update:function(){const e=t.position.getVector(),n=Math.round(e.x/this.scale),i=Math.round(e.y/this.scale),r=Math.round(e.z/this.scale);if(this.current&&this.current.x==n&&this.current.y==i&&this.current.z==r)return this;const o=this.radius,s=[],a=new Set,c=new Set(this.loaded);for(let t=n-o;t<=n+o;t+=1)for(let e=i-o;e<=i+o;e+=1)for(let e=i-o;e<=i+o;e+=1){let n=this.cache.get(t,e,z);n?c.delete(n):(n={x:t,y:e,z:z,...this.generate(t,e,z)||{}},this.cache.set(t,e,z,n),a.add(n)),s.push(n)}for(const t of a)this.pubsub.emit("load",t);for(const t of c)this.pubsub.emit("unload",t);return this.loaded=s,this.current=this.cache.get(n,i,r),this}},t.tool.matrix4d={},t.tool.matrix4d.create=function(...t){return Object.create(this.prototype).construct(...t)},t.tool.matrix4d.fromEuler=function({pitch:e=0,roll:n=0,yaw:i=0},r=t.const.eulerToQuaternion){const o=t.tool.matrix4d.create([1,0,0,0,0,Math.cos(n),Math.sin(n),0,0,-Math.sin(n),Math.cos(n),0,0,0,0,1]),s=t.tool.matrix4d.create([Math.cos(e),0,-Math.sin(e),0,0,1,0,0,Math.sin(e),0,Math.cos(e),0,0,0,0,1]),a=t.tool.matrix4d.create([Math.cos(i),-Math.sin(i),0,0,Math.sin(i),Math.cos(i),0,0,0,0,1,0,0,0,0,1]);switch(r){case"XYZ":return s.multiply(s).multiply(o);case"XZY":return s.multiply(a).multiply(o);case"YXZ":return a.multiply(o).multiply(o);case"YZX":return o.multiply(a).multiply(s);case"ZXY":return s.multiply(o).multiply(o);case"ZYX":return o.multiply(s).multiply(a)}},t.tool.matrix4d.fromQuaternion=function(e,n=t.const.eulerToQuaternion){return this.fromEuler(t.tool.euler.fromQuaternion(e),n)},t.tool.matrix4d.identity=function(...t){return this.create([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])},t.tool.matrix4d.scale=function(t=1){const e="number"==typeof t,n=e?t:"x"in t?t.x:1,i=e?t:"y"in t?t.y:1,r=e?t:"z"in t?t.z:1;return this.create([n,0,0,0,0,i,0,0,0,0,r,0,0,0,0,1])},t.tool.matrix4d.translate=function({x:e=0,y:n=0,z:i=0}={}){return t.tool.matrix4d.create([1,0,0,e,0,1,0,n,0,0,1,i,0,0,0,1])},t.tool.matrix4d.prototype={construct:function(t=[]){this.elements=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],t=t.slice(0,16);for(const e in t)this.elements[e]=t[e];return this},applyToVector3d:function({x:e=0,y:n=0,z:i=0}={}){const[r,o,s,a,c,u,h,l,f,d,p,m,y,g,x,v]=this.elements;return t.tool.vector3d.create({x:e*r+n*c+i*f+1*y,y:e*o+n*u+i*d+1*g,z:e*s+n*h+i*p+1*x})},multiply:function(e=t.tool.matrix4d.identity()){t.tool.matrix4d.prototype.isPrototypeOf(e)||(e=t.tool.matrix4d.create(e));const[n,i,r,o,s,a,c,u,h,l,f,d,p,m,y,g]=this.elements,[x,v,w,b,M,q,z,G,D,P,F,S,O,I,A,T]=e.elements,E=[];return E[0]=n*x+s*v+h*w+p*b,E[4]=n*M+s*q+h*z+p*G,E[8]=n*D+s*P+h*F+p*S,E[12]=n*O+s*I+h*A+p*T,E[1]=i*x+a*v+l*w+m*b,E[5]=i*M+a*q+l*z+m*G,E[9]=i*D+a*P+l*F+m*S,E[13]=i*O+a*I+l*A+m*T,E[2]=r*x+c*v+f*w+y*b,E[6]=r*M+c*q+f*z+y*G,E[10]=r*D+c*P+f*F+y*S,E[14]=r*O+c*I+f*A+y*T,E[3]=o*x+u*v+d*w+g*b,E[7]=o*M+u*q+d*z+g*G,E[11]=o*D+u*P+d*F+g*S,E[15]=o*O+u*I+d*A+g*T,t.tool.matrix4d.create(E)},set:function(t,e,n){const i=4*e+t;return this.setIndex(i,n)},setIndex:function(t,e){return this.elements[t]=e,this},transpose:function(){const[e,n,i,r,o,s,a,c,u,h,l,f,d,p,m,y]=this.elements;return t.tool.matrix4d.create([e,o,u,d,n,s,h,p,i,a,l,m,r,c,f,y])}},t.tool.noise={},t.tool.noise.create=function(...t){return Object.create(this.prototype).construct(...t)},t.tool.noise.prototype={construct:function(...t){return this.gradient=new Map,this.seed=t,this},generateGradient:function(e){return t.fn.srand("noise",...this.seed,e)(0,1)},getGradient:function(t){let e=this.gradient.get(t);return e||(e=this.generateGradient(t),this.gradient.set(t,e)),e},reset:function(){return this.gradient.clear(),this},smooth:function(t){return t**3*(t*(6*t-15)+10)},value:function(e){const n=Math.floor(e),i=n+1,r=this.smooth(e-n),o=this.getGradient(n),s=this.getGradient(i);return t.fn.clamp(t.fn.lerp(o,s,r),0,1)}},t.tool.octree={},t.tool.octree.create=function(t={}){return Object.create(this.prototype).construct(t)},t.tool.octree.from=function(t=[],e={}){const n=this.create(e);for(const e of t)n.insert(e);return n},t.tool.octree.prototype={clear:function(){return this.items.length=0,this.nodes.length=0,this},construct:function({depth:e=2*t.const.maxSafeFloat,height:n=2*t.const.maxSafeFloat,maxItems:i=32,width:r=2*t.const.maxSafeFloat,x:o=-t.const.maxSafeFloat,y:s=-t.const.maxSafeFloat,z:a=-t.const.maxSafeFloat}={}){return this.depth=e,this.height=n,this.items=[],this.maxItems=i,this.nodes=[],this.width=r,this.x=o,this.y=s,this.z=a,this.center={x:this.x+this.width/2,y:this.y+this.height/2,z:this.z+this.depth/2},this.radius=Math.max(this.height,this.width,this.depth)/t.const.unit3,this},destroy:function(){return this.clear()},filter:function(t,e,n=[]){if(!t(this.center,this.radius))return n;if(this.items.length)for(const t of this.items)e?e(t)&&n.push(t):n.push(t);else if(this.nodes.length)for(const i of this.nodes)i.filter(t,e,n);return n},find:function(e={},n=1/0){if(isFinite(n)&&!this.intersects({depth:2*n,height:2*n,width:2*n,x:e.x-n,y:e.y-n,z:e.z-n}))return;const i=n*n;if(this.items.length){let n,r=i;for(const i of this.items){if(i===e)continue;const o=t.fn.distance2(e,i);o<r&&(r=o,n=i)}return n}let r,o=i;for(const n of this.nodes){const i=n.find(e,Math.sqrt(o));if(!i||i===e)continue;const s=t.fn.distance2(e,i);s<o&&(o=s,r=i)}return r},getIndex:function({x:t=0,y:e=0,z:n=0}={}){if(!this.nodes.length)return-1;const i=t<=this.center.x,r=e<=this.center.y;return n<=this.center.z?i&&r?0:!i&&r?1:i&&!r?2:3:i&&r?4:!i&&r?5:i&&!r?6:7},insert:function(t={}){if(!("x"in t&&"y"in t&&"z"in t))return this;const e=this.getIndex(t);return-1!=e?(this.nodes[e].insert(t),this):(this.items.push(t),this.items.length>this.maxItems&&this.split(),this)},intersects:function(e){return t.fn.intersects(this,e)},remove:function(t){if(this.nodes.length){const e=this.getIndex(t);return this.nodes[e].remove(t),this}const e=this.items.indexOf(t);return-1!=e&&this.items.splice(e,1),this},retrieve:function({depth:t=0,height:e=0,width:n=0,x:i=0,y:r=0,z:o=0}={}){const s=[];if(!this.intersects({depth:t,height:e,width:n,x:i,y:r,z:o}))return s;for(const a of this.items)a.x>=i&&a.x<=i+n&&a.y>=r&&a.y<=r+e&&a.z>=o&&a.z<=o+t&&s.push(a);for(const a of this.nodes)s.push(...a.retrieve({depth:t,height:e,width:n,x:i,y:r,z:o}));return s},split:function(){if(this.nodes.length)return this;const e=this.depth/2,n=this.height/2,i=this.width/2;this.nodes[0]=t.tool.octree.create({depth:e,height:n,maxItems:this.maxItems,width:i,x:this.x,y:this.y,z:this.z}),this.nodes[1]=t.tool.octree.create({depth:e,height:n,maxItems:this.maxItems,width:i,x:this.x+i,y:this.y,z:this.z}),this.nodes[2]=t.tool.octree.create({depth:e,height:n,maxItems:this.maxItems,width:i,x:this.x,y:this.y+n,z:this.z}),this.nodes[3]=t.tool.octree.create({depth:e,height:n,maxItems:this.maxItems,width:i,x:this.x+i,y:this.y+n,z:this.z}),this.nodes[4]=t.tool.octree.create({depth:e,height:n,maxItems:this.maxItems,width:i,x:this.x,y:this.y,z:this.z+e}),this.nodes[5]=t.tool.octree.create({depth:e,height:n,maxItems:this.maxItems,width:i,x:this.x+i,y:this.y,z:this.z+e}),this.nodes[6]=t.tool.octree.create({depth:e,height:n,maxItems:this.maxItems,width:i,x:this.x,y:this.y+n,z:this.z+e}),this.nodes[7]=t.tool.octree.create({depth:e,height:n,maxItems:this.maxItems,width:i,x:this.x+i,y:this.y+n,z:this.z+e});for(const t of this.items){const e=this.getIndex(t);this.nodes[e].insert(t)}return this.items.length=0,this}},t.tool.perlin2d={},t.tool.perlin2d.create=function(...t){return Object.create(this.prototype).construct(...t)},t.tool.perlin2d.prototype={construct:function(...t){return this.gradient=new Map,this.seed=t,this},generateGradient:function(e,n){const i=t.fn.srand("perlin",...this.seed,e,n);return[i(-1,1),i(-1,1)]},getDotProduct:function(t,e,n,i){const r=n-t,o=i-e,s=this.getGradient(t,e);return r*s[0]+o*s[1]},getGradient:function(t,e){let n=this.gradient.get(t);n||(n=new Map,this.gradient.set(t,n));let i=n.get(e);return i||(i=this.generateGradient(t,e),n.set(e,i)),i},range:Math.sqrt(.5),reset:function(){return this.gradient.clear(),this},smooth:function(t){return t**3*(t*(6*t-15)+10)},value:function(e,n){const i=Math.floor(e),r=i+1,o=Math.floor(n),s=o+1,a=this.smooth(e-i),c=this.smooth(n-o),u=t.fn.lerp(t.fn.lerp(this.getDotProduct(i,o,e,n),this.getDotProduct(r,o,e,n),a),t.fn.lerp(this.getDotProduct(i,s,e,n),this.getDotProduct(r,s,e,n),a),c);return t.fn.clamp(t.fn.scale(u,-this.range,this.range,0,1),0,1)}},t.tool.perlin3d={},t.tool.perlin3d.create=function(...t){return Object.create(this.prototype).construct(...t)},t.tool.perlin3d.prototype={construct:function(...t){return this.gradient=new Map,this.seed=t,this},generateGradient:function(e,n,i){const r=t.fn.srand("perlin",...this.seed,e,n,i);return[r(-1,1),r(-1,1),r(-1,1)]},getDotProduct:function(t,e,n,i,r,o){const s=i-t,a=r-e,c=o-n,u=this.getGradient(t,e,n);return s*u[0]+a*u[1]+c*u[2]},getGradient:function(t,e,n){let i=this.gradient.get(t);i||(i=new Map,this.gradient.set(t,i));let r=i.get(e);r||(r=new Map,i.set(e,r));let o=r.get(n);return o||(o=this.generateGradient(t,e,n),r.set(n,o)),o},range:Math.sqrt(3/4),reset:function(){return this.gradient.clear(),this},smooth:function(t){return t**3*(t*(6*t-15)+10)},value:function(e,n,i){const r=Math.floor(e),o=r+1,s=Math.floor(n),a=s+1,c=Math.floor(i),u=c+1,h=this.smooth(e-r),l=this.smooth(n-s),f=this.smooth(i-c),d=t.fn.lerp(t.fn.lerp(t.fn.lerp(this.getDotProduct(r,s,c,e,n,i),this.getDotProduct(o,s,c,e,n,i),h),t.fn.lerp(this.getDotProduct(r,a,c,e,n,i),this.getDotProduct(o,a,c,e,n,i),h),l),t.fn.lerp(t.fn.lerp(this.getDotProduct(r,s,u,e,n,i),this.getDotProduct(o,s,u,e,n,i),h),t.fn.lerp(this.getDotProduct(r,a,u,e,n,i),this.getDotProduct(o,a,u,e,n,i),h),l),f);return t.fn.clamp(t.fn.scale(d,-this.range,this.range,0,1),0,1)}},t.tool.perlin4d={},t.tool.perlin4d.create=function(...t){return Object.create(this.prototype).construct(...t)},t.tool.perlin4d.prototype={construct:function(...t){return this.gradient=new Map,this.seed=t,this},generateGradient:function(e,n,i,r){const o=t.fn.srand("perlin",...this.seed,e,n,i,r);return[o(-1,1),o(-1,1),o(-1,1),o(-1,1)]},getDotProduct:function(t,e,n,i,r,o,s,a){const c=a-i,u=r-t,h=o-e,l=s-n,f=this.getGradient(t,e,n,i);return u*f[0]+h*f[1]+l*f[2]+c*f[3]},getGradient:function(t,e,n,i){let r=this.gradient.get(t);r||(r=new Map,this.gradient.set(t,r));let o=r.get(e);o||(o=new Map,r.set(e,o));let s=o.get(n);s||(s=new Map,o.set(n,s));let a=s.get(i);return a||(a=this.generateGradient(t,e,n,i),s.set(i,a)),a},range:Math.sqrt(1),reset:function(){return this.gradient.clear(),this},smooth:function(t){return t**3*(t*(6*t-15)+10)},value:function(e,n,i,r){const o=Math.floor(r),s=o+1,a=Math.floor(e),c=a+1,u=Math.floor(n),h=u+1,l=Math.floor(i),f=l+1,d=this.smooth(r-o),p=this.smooth(e-a),m=this.smooth(n-u),y=this.smooth(i-l),g=t.fn.lerp(t.fn.lerp(t.fn.lerp(t.fn.lerp(this.getDotProduct(a,u,l,o,e,n,i,r),this.getDotProduct(c,u,l,o,e,n,i,r),p),t.fn.lerp(this.getDotProduct(a,h,l,o,e,n,i,r),this.getDotProduct(c,h,l,o,e,n,i,r),p),m),t.fn.lerp(t.fn.lerp(this.getDotProduct(a,u,f,o,e,n,i,r),this.getDotProduct(c,u,f,o,e,n,i,r),p),t.fn.lerp(this.getDotProduct(a,h,f,o,e,n,i,r),this.getDotProduct(c,h,f,o,e,n,i,r),p),m),y),t.fn.lerp(t.fn.lerp(t.fn.lerp(this.getDotProduct(a,u,l,s,e,n,i,r),this.getDotProduct(c,u,l,s,e,n,i,r),p),t.fn.lerp(this.getDotProduct(a,h,l,s,e,n,i,r),this.getDotProduct(c,h,l,s,e,n,i,r),p),m),t.fn.lerp(t.fn.lerp(this.getDotProduct(a,u,f,s,e,n,i,r),this.getDotProduct(c,u,f,s,e,n,i,r),p),t.fn.lerp(this.getDotProduct(a,h,f,s,e,n,i,r),this.getDotProduct(c,h,f,s,e,n,i,r),p),m),y),d);return t.fn.clamp(t.fn.scale(g,-this.range,this.range,0,1),0,1)}},t.tool.plane={},t.tool.plane.create=function(...t){return Object.create(this.prototype).construct(...t)},t.tool.plane.prototype={construct:function({constant:e=0,normal:n}={}){return this.constant=e,this.normal=t.tool.vector3d.create(n),this.normalize(),this},distanceToPoint:function(t){return this.normal.dotProduct(t)-this.constant},normalize:function(){const t=this.normal.distance();if(!t||1==t)return this;const e=1/t;return this.constant*=e,this.normal=this.normal.scale(e),this}},t.tool.pubsub={},t.tool.pubsub.create=function(){return Object.create(this.prototype).construct()},t.tool.pubsub.decorate=function(t,e){return this.prototype.isPrototypeOf(e)||(e=this.create(),t.pubsub=e),e.decorate(t),t},t.tool.pubsub.prototype={construct:function(){return this._handler={},this},destroy:function(){return this.off(),this},decorate:function(t){const e=this;return["emit","off","on","once"].forEach(n=>{t[n]=function(...t){return e[n](...t),this}}),t},emit:function(t,...e){if(!this._handler[t])return this;return[...this._handler[t]].forEach(t=>t(...e)),this},off:function(t,e){if(void 0===t)return this._handler={},this;if(void 0===e)return delete this._handler[t],this;if(!this._handler[t])return this;const n=this._handler[t],i=n.indexOf(e);return-1!=i&&n.splice(i,1),this},on:function(t,e){return e instanceof Function?(this._handler[t]||(this._handler[t]=[]),this._handler[t].push(e),this):this},once:function(t,e){const n=(...i)=>{this.off(t,n),e(...i)};return this.on(t,n)}},t.tool.quadtree={},t.tool.quadtree.create=function(t={}){return Object.create(this.prototype).construct(t)},t.tool.quadtree.from=function(t=[],e={}){const n=this.create(e);for(const e of t)n.insert(e);return n},t.tool.quadtree.prototype={clear:function(){return this.items.length=0,this.nodes.length=0,this},construct:function({height:e=2*t.const.maxSafeFloat,maxItems:n=12,width:i=2*t.const.maxSafeFloat,x:r=-t.const.maxSafeFloat,y:o=-t.const.maxSafeFloat}={}){return this.height=e,this.items=[],this.maxItems=n,this.nodes=[],this.width=i,this.x=r,this.y=o,this},destroy:function(){return this.clear()},find:function(t={},e=1/0){if(!("x"in t)||!("y"in t))return;if(isFinite(e)&&!this.intersects({height:2*e,width:2*e,x:t.x-e,y:t.y-e}))return;const n=({x:e,y:n})=>(e-t.x)**2+(n-t.y)**2,i=this.getIndex(t),r=(e*(Math.sqrt(2)/2))**2*2;if(-1==i){let e,i=r;for(const r of this.items){if(r===t)continue;const o=n(r);o<i&&(i=o,e=r)}return e}let o=this.nodes[i].find(t,e),s=o?n(o):r;for(const e of this.nodes){if(e===this.nodes[i])continue;const r=e.find(t,s);if(!r)continue;const a=n(r);a<s&&(s=a,o=r)}return o},getIndex:function({x:t=0,y:e=0}={}){if(!this.nodes.length)return-1;const n=this.x+this.width/2,i=this.y+this.height/2;return t<=n&&e<=i?0:t>=n&&e<=i?1:t<=n&&e>=i?2:3},insert:function(t={}){if(!("x"in t)||!("y"in t))return this;const e=this.getIndex(t);return-1!=e?(this.nodes[e].insert(t),this):(this.items.push(t),this.items.length>this.maxItems&&this.split(),this)},intersects:function(e){return t.fn.intersects(this,e)},remove:function(t){if(this.nodes.length){const e=this.getIndex(t);return this.nodes[e].remove(t),this}const e=this.items.indexOf(t);return-1!=e&&this.items.splice(e,1),this},retrieve:function({height:t=0,width:e=0,x:n=0,y:i=0}={}){const r=[];if(!this.intersects({height:t,width:e,x:n,y:i}))return r;for(const o of this.items)o.x>=n&&o.x<=n+e&&o.y>=i&&o.y<=i+t&&r.push(o);for(const o of this.nodes)r.push(...o.retrieve({height:t,width:e,x:n,y:i}));return r},split:function(){if(this.nodes.length)return this;const e=this.height/2,n=this.width/2;this.nodes[0]=t.tool.quadtree.create({height:e,maxItems:this.maxItems,width:n,x:this.x,y:this.y}),this.nodes[1]=t.tool.quadtree.create({height:e,maxItems:this.maxItems,width:n,x:this.x+n,y:this.y}),this.nodes[2]=t.tool.quadtree.create({height:e,maxItems:this.maxItems,width:n,x:this.x,y:this.y+e}),this.nodes[3]=t.tool.quadtree.create({height:e,maxItems:this.maxItems,width:n,x:this.x+n,y:this.y+e});for(const t of this.items){const e=this.getIndex(t);this.nodes[e].insert(t)}return this.items.length=0,this}},t.tool.quaternion={},t.tool.quaternion.create=function(t={}){return Object.create(this.prototype).construct(t)},t.tool.quaternion.fromEuler=function({pitch:e=0,roll:n=0,yaw:i=0}={},r=t.const.eulerToQuaternion){r=r.toUpperCase();const o=n/2,s=e/2,a=i/2,c=Math.cos(o),u=Math.cos(s),h=Math.cos(a),l=Math.sin(o),f=Math.sin(s),d=Math.sin(a);switch(r){case"XYZ":return this.create({w:c*u*h-l*f*d,x:l*u*h+c*f*d,y:c*f*h-l*u*d,z:c*u*d+l*f*h});case"XZY":return this.create({w:c*u*h+l*f*d,x:l*u*h-c*f*d,y:c*f*h-l*u*d,z:c*u*d+l*f*h});case"YXZ":return this.create({w:c*u*h+l*f*d,x:l*u*h+c*f*d,y:c*f*h-l*u*d,z:c*u*d-l*f*h});case"YZX":return this.create({w:c*u*h-l*f*d,x:l*u*h+c*f*d,y:c*f*h+l*u*d,z:c*u*d-l*f*h});case"ZXY":return this.create({w:c*u*h-l*f*d,x:l*u*h-c*f*d,y:c*f*h+l*u*d,z:c*u*d+l*f*h});case"ZYX":return this.create({w:c*u*h+l*f*d,x:l*u*h-c*f*d,y:c*f*h+l*u*d,z:c*u*d-l*f*h})}},t.tool.quaternion.prototype={clone:function(){return t.tool.quaternion.create(this)},conjugate:function(){return t.tool.quaternion.create({w:this.w,x:-this.x,y:-this.y,z:-this.z})},construct:function({w:t=1,x:e=0,y:n=0,z:i=0}={}){return this.w=t,this.x=e,this.y=n,this.z=i,this},distance:function(){return Math.sqrt(this.w**2+this.x**2+this.y**2+this.z**2)},distance2:function(){return this.w**2+this.x**2+this.y**2+this.z**2},divide:function(e){return t.tool.quaternion.prototype.isPrototypeOf(quaternion)||(quaternion=t.tool.quaternion.create(quaternion)),this.multiply(quaternion.inverse())},equals:function({w:t=1,x:e=0,y:n=0,z:i=0}={}){return this.w==t&&this.x==e&&this.y==n&&this.z==i},forward:function(){return t.tool.vector3d.unitX().rotateQuaternion(this)},inverse:function(){const t=1/this.distance2();return isFinite(t)?this.conjugate().scale(t):this.conjugate()},isZero:function(){return 1==this.w&&!this.x&&!this.y&&!this.z},lerpFrom:function({w:e=1,x:n=0,y:i=0,z:r=0}={},o=0){return t.tool.quaternion.create({w:t.fn.lerp(e,this.w,o),x:t.fn.lerp(n,this.x,o),y:t.fn.lerp(i,this.y,o),z:t.fn.lerp(r,this.z,o)})},lerpTo:function({w:e=1,x:n=0,y:i=0,z:r=0}={},o=0){return t.tool.quaternion.create({w:t.fn.lerp(this.w,e,o),x:t.fn.lerp(this.x,n,o),y:t.fn.lerp(this.y,i,o),z:t.fn.lerp(this.z,r,o)})},multiply:function({w:e=1,x:n=0,y:i=0,z:r=0}={}){return t.tool.quaternion.create({w:this.w*e-this.x*n-this.y*i-this.z*r,x:this.w*n+this.x*e+this.y*r-this.z*i,y:this.w*i+this.y*e+this.z*n-this.x*r,z:this.w*r+this.z*e+this.x*i-this.y*n})},normalize:function(){const t=this.distance();return t?this.scale(1/t):this.clone()},right:function(){return t.tool.vector3d.unitY().rotateQuaternion(this)},scale:function(e=0){return t.tool.quaternion.create({w:this.w*e,x:this.x*e,y:this.y*e,z:this.z*e})},set:function({w:t=1,x:e=0,y:n=0,z:i=0}={}){return this.w=t,this.x=e,this.y=n,this.z=i,this},up:function(){return t.tool.vector3d.unitZ().rotateQuaternion(this)},w:1,x:0,y:0,z:0},t.tool.quaternion.identity=function(){return Object.create(this.prototype).construct({w:1})},t.tool.simplex2d={},t.tool.simplex2d.create=function(...t){return Object.create(this.prototype).construct(...t)},t.tool.simplex2d.prototype={construct:function(...t){return this.gradient=new Map,this.seed=t,this},generateGradient:function(e,n){const i=t.fn.srand("simplex",...this.seed,e,n);let r=i(-1,1),o=i(-1,1);const s=Math.sqrt(r*r+o*o);return s>1&&(r/=s,o/=s),[r,o]},getGradient:function(t,e){let n=this.gradient.get(t);n||(n=new Map,this.gradient.set(t,n));let i=n.get(e);return i||(i=this.generateGradient(t,e),n.set(e,i)),i},range:1/99,reset:function(){return this.gradient.clear(),this},skewFactor:(Math.sqrt(3)-1)/2,unskewFactor:(3-Math.sqrt(3))/6,value:function(e,n){const i=this.skewFactor,r=this.unskewFactor,o=(e+n)*i,s=Math.floor(e+o),a=Math.floor(n+o),c=(s+a)*r,u=e-(s-c),h=n-(a-c),l=u>h?1:0,f=u>h?0:1,d=u-l+r,p=h-f+r,m=u-1+2*r,y=h-1+2*r,g=.5-u*u-h*h;let x=0;if(g>=0){const t=this.getGradient(s,a);x=g*g*g*g*(t[0]*u+t[1]*h)}const v=.5-d*d-p*p;let w=0;if(v>=0){const t=this.getGradient(s+l,a+f);w=v*v*v*v*(t[0]*d+t[1]*p)}const b=.5-m*m-y*y;let M=0;if(b>=0){const t=this.getGradient(s+1,a+1);M=b*b*b*b*(t[0]*m+t[1]*y)}return t.fn.clamp(t.fn.scale(x+w+M,-this.range,this.range,0,1),0,1)}},t.tool.simplex3d={},t.tool.simplex3d.create=function(...t){return Object.create(this.prototype).construct(...t)},t.tool.simplex3d.prototype={construct:function(...t){return this.gradient=new Map,this.seed=t,this},generateGradient:function(e,n,i){const r=t.fn.srand("simplex",...this.seed,e,n,i);let o=r(-1,1),s=r(-1,1),a=r(-1,1);const c=Math.sqrt(o*o+s*s+a*a);return c>1&&(o/=c,s/=c,a/=c),[o,s,a]},getGradient:function(t,e,n){let i=this.gradient.get(t);i||(i=new Map,this.gradient.set(t,i));let r=i.get(e);r||(r=new Map,i.set(e,r));let o=r.get(n);return o||(o=this.generateGradient(t,e,n),r.set(n,o)),o},range:1/107,reset:function(){return this.gradient.clear(),this},skewFactor:1/3,unskewFactor:1/6,value:function(e,n,i){const r=this.skewFactor,o=this.unskewFactor,s=(e+n+i)*r,a=Math.floor(e+s),c=Math.floor(n+s),u=Math.floor(i+s),h=(a+c+u)*o,l=e-(a-h),f=n-(c-h),d=i-(u-h);let p,m,y,g,x,v;l>=f?f>=d?(p=1,m=0,y=0,g=1,x=1,v=0):l>=d?(p=1,m=0,y=0,g=1,x=0,v=1):(p=0,m=0,y=1,g=1,x=0,v=1):f<d?(p=0,m=0,y=1,g=0,x=1,v=1):l<d?(p=0,m=1,y=0,g=0,x=1,v=1):(p=0,m=1,y=0,g=1,x=1,v=0);const w=l-p+o,b=f-m+o,M=d-y+o,q=l-g+2*o,z=f-x+2*o,G=d-v+2*o,D=l-1+3*o,P=f-1+3*o,F=d-1+3*o,S=.5-l*l-f*f-d*d;let O=0;if(S>=0){const t=this.getGradient(a,c,u);O=S*S*S*S*(t[0]*l+t[1]*f+t[2]*d)}const I=.5-w*w-b*b-M*M;let A=0;if(I>=0){const t=this.getGradient(a+p,c+m,u+y);A=I*I*I*I*(t[0]*w+t[1]*b+t[2]*M)}const T=.5-q*q-z*z-G*G;let E=0;if(T>=0){const t=this.getGradient(a+g,c+x,u+v);E=T*T*T*T*(t[0]*q+t[1]*z+t[2]*G)}const Q=.5-D*D-P*P-F*F;let j=0;if(Q>=0){const t=this.getGradient(a+1,c+1,u+1);j=Q*Q*Q*Q*(t[0]*D+t[1]*P+t[2]*F)}return t.fn.clamp(t.fn.scale(O+A+E+j,-this.range,this.range,0,1),0,1)}},t.tool.simplex4d={},t.tool.simplex4d.create=function(...t){return Object.create(this.prototype).construct(...t)},t.tool.simplex4d.prototype={construct:function(...t){return this.gradient=new Map,this.seed=t,this},generateGradient:function(e,n,i,r){const o=t.fn.srand("simplex",...this.seed,e,n,i,r);let s=o(-1,1),a=o(-1,1),c=o(-1,1),u=o(-1,1);const h=Math.sqrt(s*s+a*a+c*c+u*u);return h>1&&(s/=h,a/=h,c/=h,u/=h),[s,a,c,u]},getGradient:function(t,e,n,i){let r=this.gradient.get(t);r||(r=new Map,this.gradient.set(t,r));let o=r.get(e);o||(o=new Map,r.set(e,o));let s=o.get(n);s||(s=new Map,o.set(n,s));let a=s.get(i);return a||(a=this.generateGradient(t,e,n,i),s.set(i,a)),a},range:1/108,reset:function(){return this.gradient.clear(),this},skewFactor:(Math.sqrt(5)-1)/4,unskewFactor:(5-Math.sqrt(5))/20,value:function(e,n,i,r){const o=this.skewFactor,s=this.unskewFactor,a=(e+n+i+r)*o,c=Math.floor(e+a),u=Math.floor(n+a),h=Math.floor(i+a),l=Math.floor(r+a),f=(c+u+h+l)*s,d=e-(c-f),p=n-(u-f),m=i-(h-f),y=r-(l-f);let g=0,x=0,v=0,w=0;d>p?g++:x++,d>m?g++:v++,d>y?g++:w++,p>m?x++:v++,p>y?x++:w++,m>y?v++:w++;const b=g>=3?1:0,M=x>=3?1:0,q=v>=3?1:0,z=w>=3?1:0,G=g>=2?1:0,D=x>=2?1:0,P=v>=2?1:0,F=w>=2?1:0,S=g>=1?1:0,O=x>=1?1:0,I=v>=1?1:0,A=w>=1?1:0,T=d-b+s,E=p-M+s,Q=m-q+s,j=y-z+s,X=d-G+2*s,Y=p-D+2*s,k=m-P+2*s,R=y-F+2*s,Z=d-S+3*s,V=p-O+3*s,C=m-I+3*s,L=y-A+3*s,B=d-1+4*s,W=p-1+4*s,_=m-1+4*s,N=y-1+4*s,U=.5-d*d-p*p-m*m-y*y;let $=0;if(U>=0){const t=this.getGradient(c,u,h,l);$=U*U*U*U*(t[0]*d+t[1]*p+t[2]*m+t[3]*y)}const K=.5-T*T-E*E-Q*Q-j*j;let H=0;if(K>=0){const t=this.getGradient(c+b,u+M,h+q,l+z);H=K*K*K*K*(t[0]*T+t[1]*E+t[2]*Q+t[3]*j)}const J=.5-X*X-Y*Y-k*k-R*R;let tt=0;if(J>=0){const t=this.getGradient(c+G,u+D,h+P,l+F);tt=J*J*J*J*(t[0]*X+t[1]*Y+t[2]*k+t[3]*R)}const et=.5-Z*Z-V*V-C*C-L*L;let nt=0;if(et>=0){const t=this.getGradient(c+S,u+O,h+I,l+A);nt=et*et*et*et*(t[0]*Z+t[1]*V+t[2]*C+t[3]*L)}const it=.5-B*B-W*W-_*_-N*N;let rt=0;if(it>=0){const t=this.getGradient(c+1,u+1,h+1,l+1);rt=it*it*it*it*(t[0]*B+t[1]*W+t[2]*_+t[3]*N)}return t.fn.clamp(t.fn.scale($+H+tt+nt+rt,-this.range,this.range,0,1),0,1)}},t.tool.sphere={},t.tool.sphere.create=function(...t){return Object.create(this.prototype).construct(...t)},t.tool.sphere.prototype={construct:function({center:e,radius:n=0}={}){return this.center=t.tool.vector3d.create(e),this.radius=n,this},containsPoint:function(t){return this.center.distance(t)<=this.radius},containsSphere:function(t,e){return this.center.distance(t)<=this.radius+e}},t.tool.streamer2d={},t.tool.streamer2d.create=function(...t){return Object.create(this.prototype).construct(...t)},t.tool.streamer2d.prototype={construct:function({radius:e=1}={}){return this.loaded=[],this.radius=e,this.tree=t.tool.quadtree.create(),t.tool.pubsub.decorate(this),this},add:function(t){return this.tree.insert(t),this},remove:function(t){return this.tree.remove(t),this.loaded.includes(t)&&(this.loaded.splice(this.loaded.indexOf(t),1),this.emit("unload",t)),this},reset:function(){for(const t of this.loaded)this.emit("unload",t);return this.loaded=[],this.tree.clear(),this},update:function(){const e=t.position.getVector(),n=this.tree.retrieve({height:2*this.radius,width:2*this.radius,x:e.x-this.radius,y:e.y-this.radius}).filter(t=>e.distance(t)<=this.radius),i=new Set(this.loaded),r=new Set(n),o=n.filter(t=>!i.has(t)),s=this.loaded.filter(t=>!r.has(t));for(const t of o)this.pubsub.emit("load",t);for(const t of s)this.pubsub.emit("unload",t);return this.loaded=n,this}},t.tool.streamer3d={},t.tool.streamer3d.create=function(...t){return Object.create(this.prototype).construct(...t)},t.tool.streamer3d.prototype={construct:function({radius:e=1}={}){return this.loaded=[],this.radius=e,this.tree=t.tool.octree.create(),t.tool.pubsub.decorate(this),this},add:function(t){return this.tree.insert(t),this},remove:function(t){return this.tree.remove(t),this.loaded.includes(t)&&(this.loaded.splice(this.loaded.indexOf(t),1),this.emit("unload",t)),this},reset:function(){for(const t of this.loaded)this.emit("unload",t);return this.loaded=[],this.tree.clear(),this},update:function(){const e=t.position.getVector(),n=this.tree.retrieve({depth:2*this.radius,height:2*this.radius,width:2*this.radius,x:e.x-this.radius,y:e.y-this.radius,z:e.z-this.radius}).filter(t=>e.distance(t)<=this.radius),i=new Set(this.loaded),r=new Set(n),o=n.filter(t=>!i.has(t)),s=this.loaded.filter(t=>!r.has(t));for(const t of o)this.pubsub.emit("load",t);for(const t of s)this.pubsub.emit("unload",t);return this.loaded=n,this}},t.tool.vector2d={},t.tool.vector2d.create=function(t={}){return Object.create(this.prototype).construct(t)},t.tool.vector2d.prototype={add:function({x:e=0,y:n=0}={}){return t.tool.vector2d.create({x:this.x+e,y:this.y+n})},angle:function(){return Math.atan2(this.y,this.x)},clone:function(){return t.tool.vector2d.create(this)},construct:function({x:t=0,y:e=0}={}){return this.x=t,this.y=e,this},crossProduct:function({x:t=0,y:e=0}={}){return this.x*e-this.y*t},distance:function({x:t=0,y:e=0}={}){return Math.sqrt((this.x-t)**2+(this.y-e)**2)},distance2:function({x:t=0,y:e=0}={}){return(this.x-t)**2+(this.y-e)**2},dotProduct:function({x:t=0,y:e=0}={}){return this.x*t+this.y*e},equals:function({x:t=0,y:e=0}={}){return this.x==t&&this.y==e},inverse:function(){return t.tool.vector2d.create({x:-this.x,y:-this.y})},isZero:function(){return!this.x&&!this.y},normalize:function(){const t=this.distance();return t?this.scale(1/t):this.clone()},rotate:function(e=0){if(0==e)return this.clone();const n=Math.cos(e),i=Math.sin(e);return t.tool.vector2d.create({x:this.x*n-this.y*i,y:this.y*n+this.x*i})},scale:function(e=0){return t.tool.vector2d.create({x:this.x*e,y:this.y*e})},set:function({x:t=0,y:e=0}={}){return this.x=t,this.y=e,this},subtract:function({x:e=0,y:n=0}={}){return t.tool.vector2d.create({x:this.x-e,y:this.y-n})},subtractRadius:function(e=0){if(e<=0)return this.clone();const n=this.distance();return e>=n?t.tool.vector2d.create():this.multiply(1-e/n)},x:0,y:0,zeroX:function(){return t.tool.vector2d.create({y:this.y})},zeroY:function(){return t.tool.vector2d.create({x:this.x})}},t.tool.vector2d.unitX=function(){return Object.create(this.prototype).construct({x:1})},t.tool.vector2d.unitY=function(){return Object.create(this.prototype).construct({y:1})},t.tool.vector3d={},t.tool.vector3d.create=function(t={}){return Object.create(this.prototype).construct(t)},t.tool.vector3d.prototype={add:function({x:e=0,y:n=0,z:i=0}={}){return t.tool.vector3d.create({x:this.x+e,y:this.y+n,z:this.z+i})},clone:function(){return t.tool.vector3d.create(this)},construct:function({x:t=0,y:e=0,z:n=0}={}){return this.x=t,this.y=e,this.z=n,this},crossProduct:function({x:e=0,y:n=0,z:i=0}={}){return t.tool.vector3d.create({x:this.y*i-this.z*n,y:this.z*e-this.x*i,z:this.x*n-this.y*e})},distance:function({x:t=0,y:e=0,z:n=0}={}){return Math.sqrt((this.x-t)**2+(this.y-e)**2+(this.z-n)**2)},distance2:function({x:t=0,y:e=0,z:n=0}={}){return(this.x-t)**2+(this.y-e)**2+(this.z-n)**2},dotProduct:function({x:t=0,y:e=0,z:n=0}={}){return this.x*t+this.y*e+this.z*n},equals:function({x:t=0,y:e=0,z:n=0}={}){return this.x==t&&this.y==e&&this.z==n},euler:function(){return t.tool.euler.create({pitch:this.z?-Math.atan2(this.z,Math.sqrt(this.x**2+this.y**2)):0,roll:0,yaw:Math.atan2(this.y,this.x)})},inverse:function(){return t.tool.vector3d.create({x:-this.x,y:-this.y,z:-this.z})},invertZ:function(){return t.tool.vector3d.create({x:this.x,y:this.y,z:-this.z})},isZero:function(){return!this.x&&!this.y&&!this.z},normalize:function(){const t=this.distance();return t?this.scale(1/t):this.clone()},quaternion:function(){return t.tool.quaternion.fromEuler(this.euler())},rotateEuler:function(e,n){return this.rotateQuaternion(t.tool.quaternion.fromEuler(e,n))},rotateQuaternion:function(e){return t.tool.quaternion.prototype.isPrototypeOf(e)||(e=t.tool.quaternion.create(e)),e.isZero()?this.clone():t.tool.vector3d.create(e.multiply(t.tool.quaternion.create(this)).multiply(e.inverse())).invertZ()},scale:function(e=0){return t.tool.vector3d.create({x:this.x*e,y:this.y*e,z:this.z*e})},set:function({x:t=0,y:e=0,z:n=0}={}){return this.x=t,this.y=e,this.z=n,this},subtract:function({x:e=0,y:n=0,z:i=0}={}){return t.tool.vector3d.create({x:this.x-e,y:this.y-n,z:this.z-i})},subtractRadius:function(e=0){if(e<=0)return this.clone();const n=this.distance();return e>=n?t.tool.vector3d.create():this.scale(1-e/n)},x:0,y:0,z:0,zeroX:function(){return t.tool.vector3d.create({y:this.y,z:this.z})},zeroY:function(){return t.tool.vector3d.create({x:this.x,z:this.z})},zeroZ:function(){return t.tool.vector3d.create({x:this.x,y:this.y})}},t.tool.vector3d.unitX=function(){return Object.create(this.prototype).construct({x:1})},t.tool.vector3d.unitY=function(){return Object.create(this.prototype).construct({y:1})},t.tool.vector3d.unitZ=function(){return Object.create(this.prototype).construct({z:1})},t.loop=(()=>{const e=t.tool.pubsub.create();let n,i,r=0,o=0,s=!1,a=!1,c=0,u=0;function h(){cancelAnimationFrame(n),clearTimeout(i)}function l(){const t=performance.now();o=c?(t-c)/1e3:0,c=t,r+=1,u+=o,e.emit("frame",{count:r,delta:o,paused:s,time:u}),f()}function f(){document.hidden?i=setTimeout(l):n=requestAnimationFrame(l)}return document.addEventListener("visibilitychange",()=>{a&&(h(),f())}),e.decorate({delta:()=>o,frame:()=>r,isPaused:()=>s,isRunning:()=>a,pause:function(){return s||(s=!0,e.emit("pause")),this},resume:function(){return s?(s=!1,e.emit("resume"),this):this},start:function(){return a||(a=!0,f(),e.emit("start")),this},stop:function(){return a?(h(),r=0,o=0,s=!1,a=!1,c=0,u=0,e.emit("stop"),this):this},time:()=>u})})(),t.state=t.tool.pubsub.decorate({export:function(){const t={};return this.emit("export",t),t},import:function(t={}){return this.reset(),this.emit("import",t),this},reset:function(){return this.emit("reset"),this}}),t.buffer.brownNoise=({channels:e=1,duration:n=0}={})=>{const i=t.context(),r=i.sampleRate,o=n*r,s=i.createBuffer(e,o,r);e=Math.max(1,Math.round(e));for(let t=0;t<e;t+=1){const e=s.getChannelData(t);let n=0;for(let t=0;t<o;t+=1){const i=(n+.02*(2*Math.random()-1))/1.02;e[t]=3.5*i,n=i}}return s},t.buffer.impulse=({buffer:t,power:e=1})=>{if(!(t instanceof AudioBuffer))throw new Error("Invalid AudioBuffer.");const n=t.length;for(let i=0;i<t.numberOfChannels;i+=1){const r=t.getChannelData(i);for(let t=0;t<n;t+=1)r[t]*=((n-t)/n)**e}return t},t.buffer.pinkNoise=({channels:e=1,duration:n=0}={})=>{const i=t.context(),r=i.sampleRate,o=n*r,s=i.createBuffer(e,o,r);e=Math.max(1,Math.round(e));for(let t=0;t<e;t+=1){const e=s.getChannelData(t);let n=0,i=0,r=0,a=0,c=0,u=0,h=0;for(let t=0;t<o;t+=1){const o=2*Math.random()-1;n=.99886*n+.0555179*o,i=.99332*i+.0750759*o,r=.969*r+.153852*o,a=.8665*a+.3104856*o,c=.55*c+.5329522*o,u=-.7616*u-.016898*o,e[t]=.11*(n+i+r+a+c+u+h+.5362*o),h=.115926*o}}return s},t.buffer.whiteNoise=({channels:e=1,duration:n=0}={})=>{const i=t.context(),r=i.sampleRate,o=n*r,s=i.createBuffer(e,o,r);e=Math.max(1,Math.round(e));for(let t=0;t<e;t+=1){const e=s.getChannelData(t);for(let t=0;t<o;t+=1)e[t]=2*Math.random()-1}return s},t.ear.filterModel.base={defaults:{},options:{},calculate:function(){},extend:function(e={}){return(e=t.fn.extend(this,e)).defaults={...this.defaults,...e.defaults},e.options={...e.defaults},e},instantiate:function(t={}){const e=Object.create(this);return e.options={...this.defaults,...t},e}},t.ear.filterModel.head=t.ear.filterModel.base.extend({defaults:{coneRadius:Math.PI/4,power:1,width:.1524},calculate:function(e){return t.fn.lerpExp(t.const.speedOfSound/this.options.width,t.const.maxFrequency,t.fn.clamp(t.fn.scale(e,-1,Math.sin(this.options.coneRadius),0,1)),this.options.power)}}),t.ear.filterModel.musical=t.ear.filterModel.base.extend({defaults:{coneRadius:Math.PI/4,frequency:440,maxColor:8,minColor:1,power:2},calculate:function(e){return Math.min(t.fn.lerpExp(this.options.frequency*this.options.minColor,this.options.frequency*this.options.maxColor,t.fn.clamp(t.fn.scale(e,-1,Math.sin(this.options.coneRadius),0,1)),this.options.power),t.const.maxFrequency)}}),t.ear.gainModel.base={defaults:{},options:{},calculate:function(){},extend:function(e={}){return(e=t.fn.extend(this,e)).defaults={...this.defaults,...e.defaults},e.options={...e.defaults},e},instantiate:function(t={}){const e=Object.create(this);return e.options={...this.defaults,...t},e}},t.ear.gainModel.exponential=t.ear.gainModel.base.extend({defaults:{maxDistance:100,maxGain:1,minDistance:1,minGain:t.const.zeroGain,power:2},calculate:function(e){return t.fn.lerpExp(this.options.minGain,this.options.maxGain,t.fn.clamp(t.fn.scale(e,this.options.minDistance,this.options.maxDistance,1,0)),this.options.power)}}),t.ear.gainModel.linear=t.ear.gainModel.base.extend({defaults:{maxDistance:100,maxGain:1,minDistance:1,minGain:t.const.zeroGain},calculate:function(e){return t.fn.lerp(this.options.minGain,this.options.maxGain,t.fn.clamp(t.fn.scale(e,this.options.minDistance,this.options.maxDistance,1,0)))}}),t.ear.gainModel.logarithmic=t.ear.gainModel.base.extend({defaults:{base:10,maxDistance:100,maxGain:1,minDistance:1,minGain:t.const.zeroGain},calculate:function(e){return t.fn.lerpLog(this.options.minGain,this.options.maxGain,t.fn.clamp(t.fn.scale(e,this.options.minDistance,this.options.maxDistance,1,0)),this.options.base)}}),t.ear.gainModel.normalize=t.ear.gainModel.base.extend({defaults:{gain:1},calculate:function(){return this.options.gain}}),t.ear.gainModel.realistic=t.ear.gainModel.base.extend({defaults:{power:2},calculate:function(t){return 1/Math.max(1,t)**this.options.power}}),t.ear.gainModel.realisticHorizon=t.ear.gainModel.base.extend({defaults:{horizonPower:.5,maxDistance:100,minDistance:1,power:2},calculate:function(e){return 1/Math.max(this.options.minDistance,e)**this.options.power*t.fn.clamp(t.fn.scale(e,this.options.minDistance,this.options.maxDistance,1,0))**this.options.horizonPower}}),t.mixer=(()=>{const e=t.context(),n=e.createGain(),i=e.createDynamicsCompressor(),r=e.createGain(),o=e.createGain();let s,a;function c(n=t.const.minFrequency,o=t.const.maxFrequency){s=e.createBiquadFilter(),s.type="highpass",s.frequency.value=n,a=e.createBiquadFilter(),a.type="lowpass",a.frequency.value=o,r.connect(s),s.connect(a),a.connect(i)}return i.connect(n),n.connect(o),o.connect(e.destination),n.gain.value=1,i.attack.value=t.const.zeroTime,i.knee.value=0,i.ratio.value=20,i.release.value=t.const.zeroTime,i.threshold.value=0,c(),{createBus:()=>{const t=e.createGain();return t.connect(r),t},input:()=>r,output:()=>o,param:{gain:o.gain,highpass:{frequency:s.frequency},limiter:{attack:i.attack,gain:n.gain,knee:i.knee,ratio:i.ratio,release:i.release,threshold:i.threshold},lowpass:{frequency:a.frequency},preGain:r.gain},rebuildFilters:function(){const t=s.frequency.value,e=a.frequency.value;return this.auxiliary.reverb.rebuildFilters(),r.disconnect(),a.disconnect(),a=null,s.disconnect(),s=null,c(t,e),this.param.highpass.frequency=s.frequency,this.param.lowpass.frequency=a.frequency,this}}})(),t.mixer.reverb=(()=>{const e=t.context(),n=e.createDelay(),i=e.createGain(),r=t.mixer.createBus(),o=t.tool.pubsub.create();let s,a,c=!0,u=e.createConvolver();function h(i=t.const.minFrequency,r=t.const.maxFrequency){s=e.createBiquadFilter(),s.type="highpass",s.frequency.value=i,a=e.createBiquadFilter(),a.type="lowpass",a.frequency.value=r,n.connect(s),s.connect(a),a.connect(u)}return u.buffer=t.buffer.impulse({buffer:t.buffer.whiteNoise({channels:2,duration:1}),power:4}),n.delayTime.value=1/64,i.connect(n),h(),u.connect(r),o.decorate({createBus:()=>{const t=e.createGain();return t.connect(i),t},gainModel:{},isActive:()=>c,output:()=>r,param:{delay:n.delayTime,gain:r.gain,highpass:{frequency:s.frequency},lowpass:{frequency:a.frequency},preGain:i.gain},rebuildFilters:function(){const t=s.frequency.value,e=a.frequency.value;return n.disconnect(),a.disconnect(),a=null,s.disconnect(),s=null,h(t,e),this.param.highpass.frequency=s.frequency,this.param.lowpass.frequency=a.frequency,this},setActive:function(t){return c==t||(c=Boolean(t),c?(o.emit("activate"),i.connect(n)):(o.emit("deactivate"),i.disconnect(n))),this},setImpulse:function(t){return i.disconnect(),u=e.createConvolver(),u.buffer=t,u.connect(r),c&&i.connect(n),this}})})(),t.mixer.reverb.gainModel.base={defaults:{},options:{},calculate:function(){},extend:function(e={}){return(e=t.fn.extend(this,e)).defaults={...this.defaults,...e.defaults},e.options={...e.defaults},e},instantiate:function(t={}){const e=Object.create(this);return e.options={...this.defaults,...t},e}},t.mixer.reverb.gainModel.bell=t.mixer.reverb.gainModel.base.extend({defaults:{bellPower:.75,distancePower:2},calculate:function(e){const n=Math.min(1/e**this.options.distancePower,t.fn.fromDb(-1));return t.fn.clamp(n**this.options.bellPower*(1-n**this.options.bellPower),t.const.zeroGain,1)}}),t.mixer.reverb.gainModel.normalize=t.mixer.reverb.gainModel.base.extend({defaults:{gain:1},calculate:function(){return this.options.gain}}),t.ephemera=(()=>{const t=new Set;let e;function n(t){t.clear?t.clear():t.reset&&t.reset()}function i(){e=60}return i(),{add:function(e){return e&&(e.clear||e.reset)?(t.add(e),this):this},remove:function(e,i=!0){return t.delete(e),i&&n(e),this},reset:function(){return function(){for(const e of t)n(t)}(),i(),this},update:function(t){return e-=t,e<=0&&this.reset(),this}}})(),t.loop.on("frame",({delta:e,paused:n})=>{n||t.ephemera.update(e)}),t.state.on("reset",()=>t.ephemera.reset()),t.formant={},t.formant.blend=(e,n,i=0)=>{const r=(e,n)=>e[n]&&e[n].frequency||t.const.zero,o=(e,n)=>e[n]&&e[n].gain||t.const.zeroGain,s=(t,e)=>t[e]&&t[e].Q||1;return[...Array(Math.max(e.length,n.length))].map((a,c)=>({frequency:t.fn.lerp(r(e,c),r(n,c),i),gain:t.fn.lerp(o(e,c),o(n,c),i),Q:t.fn.lerp(s(e,c),s(n,c),i)}))},t.formant.create=(e=[])=>{const n=t.context(),i=n.createGain(),r=n.createGain(),o=e.map(({frequency:t=0,gain:e=1,Q:o=1}={})=>{const s=n.createBiquadFilter();s.frequency.value=t,s.Q.value=o,s.type="bandpass";const a=n.createGain();return a.gain.value=e,i.connect(s),s.connect(a),a.connect(r),{filter:{frequency:s.frequency,Q:s.Q},gain:a}});return{input:i,output:r,param:{filter:o}}},t.formant.transition=function(e,n=[],i=t.const.zeroTime){const r=e.param?e.param.filter:e;if(!Array.isArray(r)||!r[0]||!r[0].filter)throw new Error("Invalid plugin");return r.forEach((e,r)=>{if(!n[r])return void t.fn.rampLinear(e.gain.gain,t.const.zeroGain,i);const{frequency:o,gain:s,Q:a}=n[r];void 0!==o&&t.fn.rampExp(e.filter.frequency,o,i),void 0!==s&&t.fn.rampLinear(e.gain.gain,s,i),void 0!==a&&t.fn.rampExp(e.filter.Q,a,i)}),t.fn.promise(1e3*i)},t.performance=(()=>{const e=[];let n=0,i=0,r=0;return{delta:()=>i,fps:()=>r,update:function({delta:o}={}){e[n]=o,n<29?n+=1:n=0;const s=e.slice().sort();return i=t.fn.choose(s,.5),r=1/i,this}}})(),t.loop.on("frame",e=>t.performance.update(e)),t.position=(()=>{const e=t.tool.quaternion.identity(),n=t.tool.vector3d.create();return{export:()=>({quaternion:{w:e.w,x:e.x,y:e.y,z:e.z},x:n.x,y:n.y,z:n.z}),getEuler:()=>t.tool.euler.fromQuaternion(e),getQuaternion:()=>e.clone(),getVector:()=>n.clone(),import:function({quaternion:i=t.tool.quaternion.identity(),x:r=0,y:o=0,z:s=0}={}){return n.x=r,n.y=o,n.z=s,e.set(i),this},reset:function(){return this.setQuaternion(),this.setVector(),this.import()},setEuler:function({pitch:e=0,roll:n=0,yaw:i=0}={}){return this.setQuaternion(t.tool.quaternion.fromEuler({pitch:e,roll:n,yaw:i}))},setQuaternion:function({w:t=1,x:n=0,y:i=0,z:r=0}={}){return e.w=t,e.x=n,e.y=i,e.z=r,this},setVector:function({x:t=0,y:e=0,z:i=0}={}){return n.x=t,n.y=e,n.z=i,this}}})(),t.state.on("export",(e={})=>e.position=t.position.export()),t.state.on("import",(e={})=>t.position.import(e.position)),t.state.on("reset",()=>t.position.reset()),t.seed=(()=>{let t;return{concat:(...e)=>(e.unshift(t),e.join("~")),get:()=>t,set:function(e){return t=e,this},valueOf:()=>t}})(),t.state.on("export",(e={})=>e.seed=t.seed.get()),t.state.on("import",(e={})=>t.seed.set(e.seed)),t.state.on("reset",()=>t.seed.set()),t.shape=(()=>{const e=F(4),n=F(6),i=F(8),r=F(12),o=O(8*Math.PI),s=S(t.const.zeroGain),a=I(2),c=A(2),u=new Float32Array(65536),h=O(4*Math.PI),l=new Float32Array([1,0,-1]),f=new Float32Array([-1,0,1]),d=S(1),p=S(t.fn.fromDb(-3)),m=S(t.fn.fromDb(-6)),y=S(t.fn.fromDb(-9)),g=S(t.fn.fromDb(-12)),x=S(t.fn.fromDb(-15)),v=new Float32Array([1,1]),w=new Float32Array([0,0,1]),b=new Float32Array([1,0,1]),M=new Float32Array(128),q=I(3),z=A(3),G=O(Math.PI),D=new Float32Array([0,0]);for(let t=0;t<u.length;t+=1){const e=t/(u.length-1)*2-1;u[t]=Math.sqrt(.5*(1+e))}const P=u.slice().reverse();for(let t=0;t<M.length;t+=1)M[t]=t<M.length/2?-1:1;function F(t=16,e=65536){const n=2**(t-1),i=new Float32Array(e);for(let t=0;t<i.length;t+=1){const r=2*t/(e-1)-1;i[t]=Math.round(r*n)/n}return i[e-1]=1,i}function S(e=1,n=65536){const i=new Float32Array(n),r=t.fn.srand("syngen.shape.createNoise",e),o=n=>t.fn.wrapAlternate(n+r(-e,e),0,2)-1;for(let t=0;t<i.length;t+=1){const e=2*t/(n-1);i[t]=o(e)}return i[n-1]=o(2),i}function O(t=0,e=65536){const n=new Float32Array(e);for(let i=0;i<e;i+=1){const r=2*i/e-1;n[i]=r*(Math.PI+t)/(Math.PI+t*Math.abs(r))}return n}function I(t=1){const e=4*t-1,n=new Float32Array(e);for(let t=0;t<e;t+=1)n[t]=t%2?0:t<e/2?-(2**(-t/2)):2**-Math.floor((e-t)/2);return n}function A(t=1){const e=2*t,n=new Float32Array(e);for(let t=0;t<e;t+=1)n[t]=t%2?0:2**(-t/2);return n}return{constant:(t=0)=>new Float32Array([t,t]),createBitcrush:F,createNoise:S,createRandom:function(e=2,n=""){const i=new Float32Array(samples),r=t.fn.srand("syngen.shape.createRandom",n);for(let t=0;t<e;t+=1)i[t]=r(-1,1);return i},createSigmoid:O,createTuple:I,createTuplePulse:A,crush12:()=>r,crush4:()=>e,crush6:()=>n,crush8:()=>i,distort:()=>o,dither:()=>s,double:()=>a,doublePulse:()=>c,equalFadeIn:()=>u,equalFadeOut:()=>P,hot:()=>h,invert:()=>l,invertShape:t=>t.map(t=>-t),linear:()=>f,noise:()=>d,noise2:()=>p,noise4:()=>m,noise8:()=>y,noise16:()=>g,noise32:()=>x,offsetShape:(t,e=0)=>t.map(t=>t+e),one:()=>v,pulse:()=>w,pulseShape:t=>t.map(t=>t>0?t:0),rectify:()=>b,rectifyShape:t=>t.map(Math.abs),reverseShape:t=>t.slice().reverse(),square:()=>M,triple:()=>q,triplePulse:()=>z,warm:()=>G,zero:()=>D}})(),t.sound={destination:t.mixer.input(),fadeInDuration:t.const.zeroTime,fadeOutDuration:t.const.zeroTime,filterModel:t.ear.filterModel.head,gainModel:t.ear.gainModel.exponential,radius:0,relative:!1,reverb:!1,reverbGainModel:t.mixer.reverb.gainModel.bell,extend:function(e){return t.fn.extend(this,e)},instantiate:function(t,...e){return Object.create(this).construct(t,...e)},construct:function({destination:e=this.destination,fadeInDuration:n=this.fadeInDuration,fadeOutDuration:i=this.fadeOutDuration,filterModel:r=this.filterModel,gainModel:o=this.gainModel,radius:s=this.radius,relative:a=this.relative,reverb:c=this.reverb,reverbGainModel:u=this.reverbGainModel,x:h=0,y:l=0,z:f=0,...d}={},...p){const m=t.context();this.destination=e,this.fadeInDuration=n,this.fadeOutDuration=i,this.filterModel=r.instantiate(),this.gainModel=o.instantiate(),this.radius=s,this.relative=a,this.reverb=c,this.vector=t.tool.vector3d.create({x:h,y:l,z:f});const y=this.getRelativeVector();return this.output=m.createGain(),this.binaural=t.ear.binaural.create({filterModel:this.filterModel,gainModel:this.gainModel,...y}).from(this.output).to(e),this.reverb&&(this.reverb=t.mixer.reverb.send.create({gainModel:u,...y}).from(this.output)),this.output.gain.value=t.const.zeroGain,t.fn.rampLinear(this.output.gain,1,this.fadeInDuration),this.update=this.update.bind(this),t.loop.on("frame",this.update),this.onConstruct(d,...p),this},destroy:function(){return t.loop.off("frame",this.update),t.fn.rampLinear(this.output.gain,t.const.zeroGain,this.fadeOutDuration),t.fn.promise(1e3*this.fadeOutDuration).then(()=>{this.output.disconnect(),this.binaural.destroy(),this.reverb&&this.reverb.destroy(),this.onDestroy()}),this},getRelativeVector:function(){return this.relative?this.vector.subtractRadius(this.radius):this.vector.subtract(t.position.getVector()).subtractRadius(this.radius).rotateQuaternion(t.position.getQuaternion().conjugate())},getVector:function(){return this.vector.clone()},setVector:function({x:e=0,y:n=0,z:i=0}){return this.vector=t.tool.vector3d.create({x:e,y:n,z:i}),this},update:function(...t){this.onUpdate(...t);const e=this.getRelativeVector();return this.binaural.update(e),this.reverb&&this.reverb.update(e),this},onConstruct:()=>{},onDestroy:()=>{},onUpdate:()=>{}},t.synth={},t.synth.prototype={assign:function(...e){return t.synth.fn.assign(this,...e)},chain:function(...e){return t.synth.fn.chain(this,...e)},chainAssign:function(...e){return t.synth.fn.chainAssign(this,...e)},chainStop:function(...e){return t.synth.fn.chainStop(this,...e)},connect:function(...t){return this.output.connect(...t),this},disconnect:function(...t){return this.output.disconnect(...t),this},filtered:function(...e){return t.synth.fn.filtered(this,...e)},shaped:function(...e){return t.synth.fn.shaped(this,...e)}},t.circuit.invert=({from:e,scale:n=1,to:i}={})=>{const r=t.context().createGain();return r.gain.value=-Math.abs(n),e&&e.connect(r),i&&r.connect(i),r},t.circuit.lerp=({chainStop:e,from:n,max:i=1,min:r=0,to:o,when:s}={})=>{const a=t.context(),c=a.createGain(),u=a.createConstantSource(),h=a.createConstantSource();c.gain.value=0,u.offset.value=i-r,h.offset.value=r,o.value=0,n.connect(c.gain),u.connect(c),c.connect(o),h.connect(o),u.start(s),h.start(s);const l={stop:(e=t.time())=>(u.stop(e),h.stop(e),this)};return e&&t.synth.chainStop(e,l),l},t.circuit.scale=({chainStop:e,from:n,fromMax:i=1,fromMin:r=0,to:o,toMax:s=1,toMin:a=0,when:c}={})=>{const u=t.context(),h=u.createConstantSource(),l=u.createGain();h.offset.value=-r,l.gain.value=1/(i-r),h.connect(l),n&&n.connect(l),h.start(c);const f=t.circuit.lerp({from:l,max:s,min:a,to:o,when:c}),d={stop:(e=t.time())=>(f.stop(e),h.stop(e),this)};return e&&t.synth.chainStop(e,d),d},t.ear.binaural={},t.ear.binaural.create=function(t){return Object.create(this.prototype).construct(t)},t.ear.binaural.prototype={defaults:{headWidth:.1524,stereoWidth:Math.PI/4},construct:function({filterModel:e=t.ear.filterModel.head,gainModel:n=t.ear.gainModel.exponential,headWidth:i=this.defaults.headWidth,stereoWidth:r=this.defaults.stereoWidth,x:o=0,y:s=0,z:a=0}={}){const c=t.context();return this.options={headWidth:i,stereoWidth:r},this.left=t.ear.monaural.create({filterModel:e,gainModel:n}),this.right=t.ear.monaural.create({filterModel:e,gainModel:n}),this.merger=c.createChannelMerger(),this.left.to(this.merger,0,0),this.right.to(this.merger,0,1),this.update({x:o,y:s,z:a}),this},destroy:function(){return this.left.destroy(),this.right.destroy(),this},from:function(t){return this.left.from(t),this.right.from(t),this},to:function(t){return this.merger.connect(t),this},update:function(e={}){return t.tool.vector3d.prototype.isPrototypeOf(e)||(e=t.tool.vector3d.create(e)),this.left.update({normal:t.tool.vector3d.create(t.tool.vector2d.unitX().rotate(this.options.stereoWidth)),relative:e.add({y:-this.options.headWidth/2})}),this.right.update({normal:t.tool.vector3d.create(t.tool.vector2d.unitX().rotate(-this.options.stereoWidth)),relative:e.add({y:this.options.headWidth/2})}),this}},t.ear.monaural={},t.ear.monaural.create=function(t){return Object.create(this.prototype).construct(t)},t.ear.monaural.prototype={defaults:{confusionRadius:1},construct:function({confusionRadius:e=this.defaults.confusionRadius,filterModel:n=t.ear.filterModel.head,gainModel:i=t.ear.gainModel.realistic}={}){const r=t.context();return this.options={confusionRadius:e},this.filterModel=n,this.gainModel=i,this.delay=r.createDelay(),this.filter=r.createBiquadFilter(),this.gain=r.createGain(),this.filter.frequency.value=t.const.maxFrequency,this.gain.gain.value=t.const.zeroGain,this.delay.connect(this.filter),this.filter.connect(this.gain),this},destroy:function(){return this},from:function(t,...e){return t.connect(this.delay,...e),this},to:function(t,...e){return this.gain.connect(t,...e),this},update:function({normal:e=t.tool.vector3d.create(),relative:n=t.tool.vector3d.create()}={}){const i=n.distance();i>1&&(n=n.scale(1/i));const r=t.fn.lerp(1,n.dotProduct(e),t.fn.clamp(i/this.options.confusionRadius)),o=t.fn.clamp(i/t.const.speedOfSound,t.const.zeroTime,1),s=this.filterModel.calculate(r),a=this.gainModel.calculate(i);return t.fn.setParam(this.delay.delayTime,o),t.fn.setParam(this.filter.frequency,s),t.fn.setParam(this.gain.gain,a),this}},t.effect.dubDelay=function({delay:e=.5,dry:n=1,feedback:i=.5,filterDetune:r=0,filterFrequency:o=t.const.maxFrequency,filterGain:s=0,filterQ:a=1,filterType:c="lowpass",maxDelayTime:u=1,wet:h=.5}={}){const l=t.context(),f=l.createDelay(u),d=l.createGain(),p=l.createGain(),m=l.createBiquadFilter(),y=l.createGain(),g=l.createGain(),x=l.createGain();return y.connect(f),y.connect(d),f.connect(m),m.connect(p),m.connect(x),p.connect(f),d.connect(g),x.connect(g),f.delayTime.value=e,d.gain.value=n,p.gain.value=i,m.detune.value=r,m.frequency.value=o,m.gain.value=s,m.Q.value=a,m.type=c,y.gain.value=1,g.gain.value=1,x.gain.value=h,{input:y,output:g,param:{dry:d.gain,delay:f.delayTime,feedback:p.gain,filter:{detune:m.detune,gain:m.gain,frequency:m.frequency,Q:m.Q},gain:g.gain,wet:x.gain}}},t.effect.feedbackDelay=({delay:e=.5,dry:n=1,feedback:i=.5,maxDelayTime:r=1,wet:o=.5}={})=>{const s=t.context(),a=s.createDelay(r),c=s.createGain(),u=s.createGain(),h=s.createGain(),l=s.createGain(),f=s.createGain();return h.connect(a),h.connect(c),a.connect(u),a.connect(f),u.connect(a),c.connect(l),f.connect(l),a.delayTime.value=e,c.gain.value=n,u.gain.value=i,h.gain.value=1,l.gain.value=1,f.gain.value=o,{input:h,output:l,param:{dry:c.gain,delay:a.delayTime,feedback:u.gain,gain:l.gain,wet:f.gain}}},t.effect.multitapDelay=({dry:e=1,tap:n=[],wet:i=.5}={})=>{const r=t.context(),o=r.createGain(),s=r.createGain(),a=r.createGain(),c=r.createGain();s.connect(o),o.connect(a),c.connect(a),o.gain.value=e,s.gain.value=1,a.gain.value=1,c.gain.value=i;const u=n.map(({delay:t=.5,feedback:e=.5,gain:n=1,maxDelayTime:i=1}={})=>{const o=r.createDelay(i),a=r.createGain(),u=r.createGain();return s.connect(u),u.connect(o),o.connect(a),o.connect(c),a.connect(o),o.delayTime.value=t,a.gain.value=e,u.gain.value=n,{delay:o.delayTime,feedback:a.gain,gain:u.gain}});return{input:s,output:a,param:{dry:o.gain,gain:a.gain,tap:u,wet:c.gain}}},t.effect.phaser=({dry:e=.5,depth:n=.001,delay:i=.01,feedback:r=t.const.zeroGain,frequency:o=1,type:s="sine",wet:a=.5,when:c=t.time()}={})=>{const u=t.context(),h=u.createDelay(),l=u.createGain(),f=u.createGain(),d=u.createGain(),p=u.createGain(),m=u.createOscillator(),y=u.createGain(),g=u.createGain();return h.delayTime.value=i,l.gain.value=n,f.gain.value=e,d.gain.value=r,m.frequency.value=o,g.gain.value=a,p.connect(f),p.connect(h),h.connect(g),h.connect(d),d.connect(h),f.connect(y),g.connect(y),m.connect(l),m.type=s,m.start(c),l.connect(h.delayTime),{input:p,output:y,param:{delay:h.delayTime,depth:l.gain,dry:f.gain,feedback:d.gain,frequency:m.frequency,gain:y.gain,wet:g.gain},stop:function(e=t.time()){return m.stop(e),this}}},t.effect.pingPongDelay=function({delay:e=.5,dry:n=1,feedback:i=.5,maxDelayTime:r=1,wet:o=.5}={}){const s=t.context(),a=s.createDelay(r),c=s.createGain(),u=s.createGain(),h=s.createGain(),l=s.createChannelMerger(2),f=s.createGain(),d=s.createStereoPanner(),p=s.createChannelSplitter(2),m=s.createGain();return h.connect(c),h.connect(d),d.connect(p),p.connect(l,0,1),p.connect(l,1,0),l.connect(a),a.connect(u),a.connect(m),u.connect(d),c.connect(f),m.connect(f),a.delayTime.value=e,c.gain.value=n,u.gain.value=i,h.gain.value=1,f.gain.value=1,m.gain.value=o,{input:h,output:f,param:{dry:c.gain,delay:a.delayTime,feedback:u.gain,gain:f.gain,wet:m.gain}}},t.effect.shaper=({curve:e=t.shape.warm(),dry:n=0,preGain:i=1,wet:r=1}={})=>{const o=t.context(),s=o.createGain(),a=o.createGain(),c=o.createGain(),u=o.createGain(),h=o.createWaveShaper(),l=o.createGain();return s.gain.value=n,u.gain.value=i,h.curve=e,l.gain.value=r,a.connect(s),a.connect(u),u.connect(h),h.connect(l),s.connect(c),l.connect(c),{input:a,output:c,param:{dry:s.gain,gain:c.gain,preGain:inputGain.gain,wet:l.gain}}},t.effect.talkbox=({dry:e=0,formant0:n=t.formant.createU(),formant1:i=t.formant.createA(),mix:r=.5,wet:o=1}={})=>{const s=t.context(),a=s.createGain(),c=s.createGain(),u=s.createGain(),h=s.createConstantSource(),l=s.createGain(),f=s.createGain(),d=s.createGain(),p=s.createGain();return a.gain.value=e,h.offset.value=r,p.gain.value=o,h.connect(f.gain),f.gain.value=0,h.connect(u),u.connect(l.gain),u.gain.value=-1,l.gain.value=1,c.connect(a),c.connect(l),c.connect(f),h.start(),l.connect(n.input),f.connect(i.input),n.output.connect(p),i.output.connect(p),a.connect(d),p.connect(d),{input:c,output:d,param:{dry:a.gain,formant0:n.param,formant1:i.param,mix:h.offset,wet:p.gain},stop:function(e=t.time()){return h.stop(e),this}}},t.formant.a=()=>[{frequency:599,gain:1,Q:5},{frequency:1001,gain:1,Q:20},{frequency:2045,gain:1,Q:50},{frequency:2933,gain:1,Q:80}],t.formant.createA=()=>t.formant.create(t.formant.a()),t.formant.e=()=>[{frequency:469,gain:1,Q:5},{frequency:2150,gain:1,Q:20},{frequency:2836,gain:1,Q:50},{frequency:3311,gain:1,Q:80}],t.formant.createE=()=>t.formant.create(t.formant.e()),t.formant.i=()=>[{frequency:274,gain:1,Q:5},{frequency:1704,gain:1,Q:20},{frequency:2719,gain:1,Q:50},{frequency:3404,gain:1,Q:80}],t.formant.createI=()=>t.formant.create(t.formant.i()),t.formant.o=()=>[{frequency:411,gain:1,Q:5},{frequency:784,gain:1,Q:20},{frequency:2176,gain:1,Q:50},{frequency:2987,gain:1,Q:80}],t.formant.createO=()=>t.formant.create(t.formant.o()),t.formant.u=()=>[{frequency:290,gain:1,Q:5},{frequency:685,gain:1,Q:20},{frequency:2190,gain:1,Q:50},{frequency:3154,gain:1,Q:80}],t.formant.createU=()=>t.formant.create(t.formant.u()),t.input.gamepad=(()=>{let e=.1875,n={analog:{},axis:{},digital:{}};function i(t){const n=(Math.abs(t)-e)/(1-e);return n>0?Math.sign(t)*n:0}return{get:()=>({analog:{...n.analog},axis:{...n.axis},digital:{...n.digital}}),getAnalog:function(t,e=!1){const i=n.analog[t]||0;return e&&i?1-i:i},getAxis:function(t,e=!1){const i=n.axis[t]||0;return e&&i?-1*i:i},hasAxis:function(...t){for(const e of t)if(!(e in n.axis))return!1;return!0},isDigital:t=>Boolean(n.digital[t]),reset:function(){return n={analog:{},axis:{},digital:{}},this},setDeadzone:function(t=0){return e=Number(t)||0,this},update:function(){const e=navigator.getGamepads();this.reset();for(const r of e)r&&(r.axes.forEach((e,r)=>{e=i(e),r in n.axis||(n.axis[r]=0),n.axis[r]=t.fn.clamp(n.axis[r]+e,-1,1)||0}),r.buttons.forEach((t,e)=>{e in n.analog||(n.analog[e]=0),n.analog[e]=Math.min(n.analog[e]+t.value,1)||0,n.digital[e]|=t.pressed}));return this}}})(),t.loop.on("frame",()=>t.input.gamepad.update()),t.input.keyboard=(()=>{let t={};return window.addEventListener("keydown",function(e){if(e.repeat)return;t[e.code]=!0}),window.addEventListener("keyup",function(e){t[e.code]=!1}),{get:()=>({...t}),is:e=>t[e]||!1,reset:function(){return t={},this}}})(),window.addEventListener("blur",e=>{e.target===window&&t.input.keyboard.reset()}),t.input.mouse=(()=>{let t={moveX:0,moveY:0,wheelX:0,wheelY:0,wheelZ:0},e={button:{},moveX:0,moveY:0,wheelX:0,wheelY:0,wheelZ:0};return window.addEventListener("mousedown",function(t){e.button[t.button]=!0}),window.addEventListener("mousemove",function(t){e.moveX+=t.movementX,e.moveY+=t.movementY}),window.addEventListener("mouseup",function(t){e.button[t.button]=!1}),window.addEventListener("wheel",function(t){e.wheelX+=t.deltaX,e.wheelY+=t.deltaY,e.wheelZ+=t.deltaZ}),{get:()=>({...e,button:{...e.button}}),getMoveX:()=>e.moveX||0,getMoveY:()=>e.moveY||0,getWheelX:()=>e.wheelX||0,getWheelY:()=>e.wheelY||0,getWheelZ:()=>e.wheelZ||0,isButton:t=>e.button[t]||!1,reset:function(){return t={moveX:0,moveY:0,wheelX:0,wheelY:0,wheelZ:0},e={button:{},moveX:0,moveY:0,wheelX:0,wheelY:0,wheelZ:0},this},update:function(){return e.moveX-=t.moveX,e.moveY-=t.moveY,e.wheelX-=t.wheelX,e.wheelY-=t.wheelY,e.wheelZ-=t.wheelZ,t={moveX:e.moveX,moveY:e.moveY,wheelX:e.wheelX,wheelY:e.wheelY,wheelZ:e.wheelZ},this}}})(),t.loop.on("frame",()=>t.input.mouse.update()),t.mixer.export=({duration:e=0,input:n=t.mixer.output(),name:i="export.webm"}={})=>{if(!(n instanceof AudioNode))throw new Error("Input must be an AudioNode");const r=t.context(),o=[],s=r.createMediaStreamDestination(),a=new MediaRecorder(s.stream);return a.ondataavailable=t=>o.push(t.data),a.onstop=()=>{try{n.disconnect(s)}catch(t){}const t=new Blob(o,{type:a.mimeType}),e=URL.createObjectURL(t),r=document.createElement("a");r.download=i,r.href=e,r.click(),r.remove()},n.connect(s),a.start(),e>0&&setTimeout(()=>a.stop(),1e3*e),a},t.synth.additive=({detune:e=0,frequency:n,gain:i=t.const.zeroGain,harmonic:r=[],when:o=t.time()}={})=>{const s=t.context(),a=s.createConstantSource(),c=s.createConstantSource(),u=s.createGain(),h=s.createGain();a.start(o),c.start(o);const l=Math.max(r.length-1,1),f=r.map(({coefficient:t=1,detune:e=0,gain:n=1,type:i="sine"})=>{const r=s.createGain(),u=s.createGain(),f=s.createOscillator();return r.gain.value=t,f.detune.value=e,f.frequency.value=0,f.type=i,u.gain.value=n/l,a.connect(f.detune),c.connect(r),r.connect(f.frequency),f.connect(u),u.connect(h),f.start(o),{oscillator:f,param:{coefficient:r.gain,detune:f.detune,gain:u.gain}}});return h.connect(u),t.synth.fn.setAudioParams([a.offset,e,o],[c.offset,n,o],[u.gain,i,o]),t.synth.fn.decorate({_chain:h,output:u,param:{detune:a.offset,frequency:c.offset,gain:u.gain,harmonic:f.map(t=>t.param)},stop:function(e=t.time()){return a.onended=()=>{u.disconnect()},a.stop(e),c.stop(e),f.forEach(t=>t.oscillator.stop(e)),this}})},t.synth.am=({carrierDetune:e=0,carrierFrequency:n,carrierGain:i=1,carrierType:r="sine",gain:o=t.const.zeroGain,modDepth:s=t.const.zeroGain,modDetune:a=0,modFrequency:c,modType:u="sine",modWhen:h,when:l=t.time()}={})=>{const f=t.context(),d=f.createGain(),p=f.createOscillator(),m=f.createGain(),y=f.createOscillator(),g=f.createGain();return h=h||l,d.connect(g),p.connect(d),p.type=r,p.start(l),m.connect(d.gain),y.connect(m),y.type=u,y.start(h),t.synth.fn.setAudioParams([d.gain,i,l],[p.detune,e,l],[p.frequency,n,l],[m.gain,s,h],[y.detune,a,h],[y.frequency,c,h],[g.gain,o,l]),t.synth.fn.decorate({_chain:d,output:g,param:{carrierGain:d.gain,detune:p.detune,frequency:p.frequency,gain:g.gain,mod:{depth:m.gain,detune:y.detune,frequency:y.frequency}},stop:function(e=t.time()){return p.onended=()=>{g.disconnect()},p.stop(e),y.stop(e),this}})},t.synth.amBuffer=({buffer:e,carrierGain:n=1,detune:i=0,gain:r=t.const.zeroGain,loop:o=!0,loopEnd:s,loopStart:a,modDepth:c=t.const.zeroGain,modDetune:u=0,modFrequency:h,modType:l="sine",modWhen:f,playbackRate:d=1,when:p=t.time()}={})=>{const m=t.context(),y=m.createGain(),g=m.createGain(),x=m.createOscillator(),v=m.createGain(),w=m.createBufferSource();return f=f||p,y.connect(v),w.buffer=e,w.loop=o,w.connect(y),w.start(p,t.fn.randomFloat(0,e.length)),o&&void 0!==s&&(w.loopEnd=s),o&&void 0!==a&&(w.loopStart=a),g.connect(y.gain),x.connect(g),x.type=l,x.start(f||p),t.synth.fn.setAudioParams([y.gain,n,p],[w.detune,i,p],[w.playbackRate,d,p],[g.gain,c,f],[x.detune,u,f],[x.frequency,h,f],[v.gain,r,p]),t.synth.fn.decorate({_chain:y,output:v,param:{carrierGain:y.gain,detune:w.detune,gain:v.gain,mod:{depth:g.gain,detune:x.detune,frequency:x.frequency},playbackRate:w.playbackRate},stop:function(e=t.time()){return w.onended=()=>{v.disconnect()},w.stop(e),x.stop(e),this}})},t.synth.buffer=({buffer:e,detune:n=0,gain:i=t.const.zeroGain,loop:r=!0,loopEnd:o,loopStart:s,playbackRate:a=1,when:c=t.time()}={})=>{const u=t.context(),h=u.createGain(),l=u.createBufferSource();return l.buffer=e,l.loop=r,l.connect(h),l.start(c,t.fn.randomFloat(0,e.length)),r&&void 0!==o&&(l.loopEnd=o),r&&void 0!==s&&(l.loopStart=s),t.synth.fn.setAudioParams([l.detune,n,c],[l.playbackRate,a,c],[h.gain,i,c]),t.synth.fn.decorate({_chain:l,output:h,param:{detune:l.detune,gain:h.gain,playbackRate:l.playbackRate},source:l,stop:function(e=t.time()){return l.onended=()=>{h.disconnect()},l.stop(e),this}})},t.synth.fm=({carrierDetune:e=0,carrierFrequency:n,carrierType:i="sine",gain:r=t.const.zeroGain,modDepth:o=t.const.zeroGain,modDetune:s=0,modFrequency:a,modType:c="sine",modWhen:u,when:h=t.time()}={})=>{const l=t.context(),f=l.createOscillator(),d=l.createGain(),p=l.createOscillator(),m=l.createGain();return u=u||h,f.connect(m),f.type=i,f.start(h),d.connect(f.frequency),p.connect(d),p.type=c,p.start(u||h),t.synth.fn.setAudioParams([f.detune,e,h],[f.frequency,n,h],[d.gain,o,u],[p.detune,s,u],[p.frequency,a,u],[m.gain,r,h]),t.synth.fn.decorate({_chain:f,output:m,param:{detune:f.detune,frequency:f.frequency,gain:m.gain,mod:{depth:d.gain,detune:p.detune,frequency:p.frequency}},stop:function(e=t.time()){return f.onended=()=>{m.disconnect()},f.stop(e),p.stop(e),this}})},t.synth.fn={},t.synth.fn.assign=function(t,e,n){return t.param||(t.param={}),e in t?(Array.isArray(t[e])||(t[e]=[t[e]],t.param[e]=[t.param[e]]),t[e].push(n),t.param[e].push(n.param||{})):(t[e]=n,t.param[e]=n.param||{}),t},t.synth.fn.chain=function(t,e){const n=e.input||e,i=e.output||e,r=t._chain,o=t.output;if(!r||!r.connect)throw new Error("Synth has no chain");if(!o||!o.connect)throw new Error("Synth has no output");if(!n||!n.connect)throw new Error("Plugin has no input");if(!i||!i.connect)throw new Error("Plugin has no output");return r.disconnect(o),r.connect(n),i.connect(o),t._chain=i,this.chainStop(t,e),t},t.synth.fn.chainAssign=function(t,e,n){return this.assign(t,e,n),this.chain(t,n),t},t.synth.fn.chainStop=function(t,e){const n=e.stop,i=t.stop;if(!n)return t;if(!i)throw new Error("Synth has no stop");return t.stop=function(...t){return n(...t),i(...t),this},t},t.synth.fn.decorate=(e={})=>Object.setPrototypeOf(e,t.synth.prototype),t.synth.fn.filtered=function(e,{detune:n,gain:i,frequency:r,Q:o,type:s="lowpass",when:a=t.time()}={}){const c=t.context().createBiquadFilter();return c.type=s,t.synth.fn.setAudioParams([c.detune,n,a],[c.gain,i,a],[c.frequency,r,a],[c.Q,o,a]),this.chainAssign(e,"filter",c)},t.synth.fn.setAudioParams=function(...e){for(const[n,i,r=t.time()]of e)n instanceof AudioParam&&void 0!==i&&(n.value=i,n.setValueAtTime(i,r));return this},t.synth.fn.shaped=function(e,n){const i=t.context().createWaveShaper();return i.curve=n,this.chainAssign(e,"shaper",i)},t.synth.lfo=({depth:e=t.const.zeroGain,detune:n=0,frequency:i=0,type:r="sine",when:o=t.time()}={})=>{const s=t.context(),a=s.createGain(),c=s.createOscillator();return c.type=r,c.connect(a),c.start(o),t.synth.fn.setAudioParams([a.gain,e,o],[c.detune,n,o],[c.frequency,i,o]),t.synth.fn.decorate({_chain:c,param:{depth:a.gain,detune:c.detune,frequency:c.frequency},output:a,stop:function(e=t.time()){return c.onended=()=>{a.disconnect()},c.stop(e),this}})},t.synth.mod=({amodDepth:e=t.const.zeroGain,amodDetune:n=0,amodFrequency:i,amodType:r="sine",amodWhen:o,carrierDetune:s=0,carrierFrequency:a,carrierGain:c=1,carrierType:u="sine",gain:h=t.const.zeroGain,fmodDepth:l=t.const.zeroGain,fmodDetune:f=0,fmodFrequency:d,fmodType:p="sine",fmodWhen:m,when:y=t.time()}={})=>{const g=t.context(),x=g.createGain(),v=g.createOscillator(),w=g.createGain(),b=g.createOscillator(),M=g.createGain(),q=g.createOscillator(),z=g.createGain();return o=o||y,m=m||y,w.connect(z),b.connect(w),b.type=u,b.start(y),x.connect(w.gain),v.connect(x),v.type=r,v.start(o||y),M.connect(b.frequency),q.connect(M),q.type=p,q.start(m||y),t.synth.fn.setAudioParams([x.gain,e,o],[v.detune,n,o],[v.frequency,i,o],[w.gain,c,y],[b.detune,s,y],[b.frequency,a,y],[M.gain,l,m],[q.detune,f,m],[q.frequency,d,m],[z.gain,h,y]),t.synth.fn.decorate({_chain:w,output:z,param:{amod:{depth:x.gain,detune:v.detune,frequency:v.frequency},carrierGain:w.gain,fmod:{depth:M.gain,detune:q.detune,frequency:q.frequency},detune:b.detune,frequency:b.frequency,gain:z.gain},stop:function(e=t.time()){return b.onended=()=>{z.disconnect()},v.stop(e),b.stop(e),q.stop(e),this}})},t.synth.pwm=({detune:e=0,frequency:n,gain:i=t.const.zeroGain,type:r="sine",when:o=t.time(),width:s=0}={})=>{const a=t.context(),c=a.createGain(),u=a.createOscillator(),h=a.createGain(),l=a.createWaveShaper(),f=a.createWaveShaper(),d=a.createGain();return u.type=r,l.curve=t.shape.one(),f.curve=t.shape.square(),c.connect(h),u.connect(l),u.connect(f),l.connect(d),f.connect(c),d.connect(f),u.start(o),t.synth.fn.setAudioParams([u.detune,e,o],[u.frequency,n,o],[h.gain,i,o],[d.gain,s,o]),t.synth.fn.decorate({_chain:c,output:h,param:{detune:u.detune,frequency:u.frequency,gain:h.gain,width:d.gain},stop:function(e=t.time()){return u.onended=()=>{h.disconnect()},u.stop(e),this},width:d})},t.synth.simple=({detune:e=0,frequency:n,gain:i=t.const.zeroGain,type:r="sine",when:o=t.time()}={})=>{const s=t.context(),a=s.createOscillator(),c=s.createGain();return a.connect(c),a.type=r,a.start(o),t.synth.fn.setAudioParams([a.detune,e,o],[a.frequency,n,o],[c.gain,i,o]),t.synth.fn.decorate({_chain:a,output:c,param:{detune:a.detune,frequency:a.frequency,gain:c.gain},stop:function(e=t.time()){return a.onended=()=>{c.disconnect()},a.stop(e),this}})},t.mixer.reverb.send={},t.mixer.reverb.send.create=function(t){return Object.create(this.prototype).construct(t)},t.mixer.reverb.send.prototype={construct:function({gainModel:e=t.mixer.reverb.gainModel.bell,x:n=0,y:i=0,z:r=0}={}){const o=t.context();return this.delay=o.createDelay(),this.gainModel=e,this.input=o.createGain(),this.relative=t.tool.vector3d.create(),this.send=t.mixer.reverb.createBus(),this.send.gain.value=t.const.zeroGain,this.onSendActivate=this.onSendActivate.bind(this),t.mixer.reverb.on("activate",this.onSendActivate),this.onSendDeactivate=this.onSendDeactivate.bind(this),t.mixer.reverb.on("deactivate",this.onSendDeactivate),t.mixer.reverb.isActive()?this.onSendActivate():this.onSendDeactivate(),this.update({x:n,y:i,z:r}),this},destroy:function(){return t.mixer.reverb.off("activate",this.onSendActivate),t.mixer.reverb.off("deactivate",this.onSendDeactivate),this.send.disconnect(),this},from:function(t){return t.connect(this.input),this},onSendActivate:function(){return this.update(this.relative),this.input.connect(this.delay),this.delay.connect(this.send),this},onSendDeactivate:function(){return this.input.disconnect(),this.delay.disconnect(),this},update:function({x:e=0,y:n=0,z:i=0}={}){if(this.relative.set({x:e,y:n,z:i}),!t.mixer.reverb.isActive())return this;const r=this.relative.distance(),o=t.fn.clamp(r/t.const.speedOfSound,t.const.zeroTime,1),s=this.gainModel.calculate(r);return t.fn.setParam(this.delay.delayTime,o),t.fn.setParam(this.send.gain,s),this}},"object"==typeof module&&"object"==typeof module.exports&&(module.exports=t),"function"==typeof define&&define.amd&&define("syngen",[],()=>t),"undefined"!=typeof self?self.syngen=t:this.syngen=t})();